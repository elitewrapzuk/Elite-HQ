<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Signature Portal (embed)</title>
  <style>/* minimal reset for embed */
    .embed-wrap{padding:8px}
    #signature-pad{border:1px solid var(--line);width:100%;height:200px;touch-action:none;display:block}
    .overlay{display:none}
    button{cursor:pointer}
  </style>
</head>
<body>
  <div class="embed-wrap">
    <div id="signaturePortalRoot">
      <h2>Agreement Details</h2>
      <div class="info-box">
        <p><strong>Client Name:</strong> <span id="cName"></span></p>
        <p><strong>Email:</strong> <span id="cEmail"></span></p>
        <p><strong>Address:</strong> <span id="cAddress"></span></p>
        <p><strong>Job Reference:</strong> <span id="cRef"></span></p>
        <p><strong>Reason for Signature:</strong> <span id="cReason"></span></p>
        <p><strong>Date:</strong> <span id="cDate"></span></p>
        <p><strong>IP Address:</strong> <span id="cIP"></span></p>
      </div>
      <canvas id="signature-pad" width="800" height="200"></canvas>
      <div class="terms">
        <label><input type="checkbox" id="termsCheck"><span id="termsLabel">I agree to the agreement above</span></label>
      </div>
      <div style="margin-top:8px"><button id="sig_clear">Clear Signature</button> <button id="sig_submit">Sign</button></div>
      <div id="sig_status" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
    (function(){
      const canvas = document.getElementById('signature-pad'); const ctx = canvas.getContext('2d'); let drawing=false; let last=null;
      function pos(e){ const r=canvas.getBoundingClientRect(); const t=e.touches?e.touches[0]:e; return {x:t.clientX-r.left,y:t.clientY-r.top}; }
      canvas.addEventListener('pointerdown', e=>{ drawing=true; last=pos(e); });
      canvas.addEventListener('pointermove', e=>{ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; });
      canvas.addEventListener('pointerup', ()=>{ drawing=false; last=null; ctx.beginPath(); });
      document.getElementById('sig_clear').addEventListener('click', ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); document.getElementById('sig_status').textContent=''; });
      document.getElementById('sig_submit').addEventListener('click', async ()=>{
        const accepted = document.getElementById('termsCheck').checked; if(!accepted){ alert('Please accept terms'); return; }
        const dataURL = canvas.toDataURL(); if(dataURL.length<2000){ alert('Please sign before submitting'); return; }
        // For embed we post to the signature handler if available, otherwise save to localStorage
        try{
          // try post to our server endpoint if exists
          if(window.fetch){
            await fetch('/api/signatures', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ signature: dataURL, meta: { date: new Date().toISOString() } }) }).catch(()=>{});
          }
        }catch(e){}
        document.getElementById('sig_status').textContent='Signature captured';
      });
    })();
  </script>
</body>
</html>
