<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Elite HQ ‚Äî Wrap Command Center</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* THEME TOKENS (Minimal Glass) */
    :root{
      --brand:#01FABF;
      --bg:#f6f8fb;
      --surface:#ffffffcc; /* glass */
      --ink:#0f172a;
      --muted:#5b6474;
      --line:#e7edf4;
      --radius:14px;
      --shadow-sm:0 4px 14px rgba(2,6,23,.06);
      --shadow-md:0 10px 30px rgba(2,6,23,.08);
      --focus:0 0 0 3px rgba(1,250,191,.35);
      --banner-grad:linear-gradient(90deg,#01FABF,#00B5FF);
      --nav-hover:#eef3f8;
      --btn:#0f172a;
      --btn-ink:#ffffff;
      --glass-ring:inset 0 1px 0 rgba(255,255,255,.6), inset 0 -1px 0 rgba(0,0,0,.03);
    }
    [data-theme="dark"]{
      --bg:#0b0f14;
      --surface:#0f1520cc;
      --ink:#e6eef6;
      --muted:#a8b3c4;
      --line:#1f2733;
      --shadow-sm:0 4px 14px rgba(0,0,0,.35);
      --shadow-md:0 14px 36px rgba(0,0,0,.5);
      --focus:0 0 0 3px rgba(1,250,191,.25);
      --banner-grad:linear-gradient(90deg,#018E77,#00A4E8);
      --nav-hover:#0f1520;
      --btn:#01FABF;
      --btn-ink:#001014;
      --glass-ring:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;color:var(--ink)}

    body{transition:background .3s ease,color .3s ease}
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}

    /* SIDEBAR (Glass) */
    .sidebar{backdrop-filter: blur(14px);background:var(--surface);border-right:1px solid var(--line);padding:16px 12px;position:sticky;top:0;height:100vh;transition:background .3s ease,border-color .3s ease;box-shadow:var(--glass-ring)}
    .logo{display:flex;align-items:center;gap:10px;padding:8px 8px 14px 8px}
    .logo-mark{width:36px;height:36px;border-radius:10px;background:#0f172a;display:grid;place-items:center;color:#01FABF;font-weight:900;letter-spacing:.5px;transition:background .3s ease,color .3s ease,box-shadow .3s ease;box-shadow:inset 0 0 0 2px rgba(1,250,191,.35);overflow:hidden}
    .logo-mark img{width:100%;height:100%;object-fit:cover;display:none}
    .logo-title{font-weight:800}
    [data-theme="dark"] .logo-mark{background:#01FABF;color:#001014;box-shadow:inset 0 0 0 2px rgba(0,16,20,.35)}
    .nav{margin-top:4px;display:flex;flex-direction:column;gap:6px}
    .nav a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;color:var(--ink);text-decoration:none;font-weight:600;font-size:13.5px;transition:background .2s ease,color .2s ease}
    .nav a:hover{background:var(--nav-hover)}
    .nav a.active{background:var(--ink);color:#fff}
    .nav a .ico{width:18px;height:18px;display:inline-block;color:currentColor}

  /* Nav groups (dropdown in sidebar) */
  .nav-group{border-radius:12px}
  .nav-group .nav-group-header{width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-radius:12px;border:1px solid transparent;background:transparent;color:var(--ink);font-weight:800;font-size:13.5px;cursor:pointer}
  .nav-group .nav-group-header:hover{background:var(--nav-hover)}
  .nav-group .nav-group-header .left{display:flex;align-items:center;gap:10px}
  .nav-group .chev{transition:transform .18s ease;opacity:.7}
  .nav-group.open .chev{transform:rotate(180deg)}
  .nav-sub{display:none;flex-direction:column;gap:6px;margin-top:6px;margin-left:4px;padding-left:8px;border-left:1px solid var(--line)}
  .nav-group.open .nav-sub{display:flex}
  .nav a.sub{padding-left:28px}
  .nav a.sub.active{background:var(--ink);color:#fff}

    /* TOP BAR (Glass) */
    .main{display:flex;flex-direction:column;min-width:0}
    .topbar{height:58px;backdrop-filter: blur(12px);background:var(--surface);border-bottom:1px solid var(--line);display:flex;align-items:center;padding:0 14px;gap:10px;position:sticky;top:0;z-index:5;transition:background .3s ease,border-color .3s ease;box-shadow:var(--glass-ring)}
    .crumb{color:var(--muted);font-weight:600;font-size:13px}
    .page-title{font-weight:800}
    .spacer{flex:1}
    .top-actions{display:flex;align-items:center;gap:8px}
    .icon-btn{height:34px;padding:0 10px;border-radius:999px;border:1px solid var(--line);background:transparent;display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:700;font-size:13px;transition:background .2s ease,color .2s ease,border-color .2s ease;box-shadow:var(--shadow-sm)}
    .icon-btn:hover{background:var(--ink);color:#fff;border-color:var(--ink)}
    .top-actions .divider{width:1px;height:22px;background:var(--line);margin:0 2px}
    .switch{position:relative;width:48px;height:26px;background:var(--nav-hover);border-radius:16px;cursor:pointer;transition:background .25s ease;border:1px solid var(--line)}
    .switch .knob{position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:#fff;box-shadow:var(--shadow-sm);transition:left .25s ease,background .3s ease}
    [data-theme="dark"] .switch{background:#06202a}
    [data-theme="dark"] .switch .knob{left:24px;background:#0b1520}
    .top-logo{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:#0f172a;color:#01FABF;font-weight:900;overflow:hidden;border:1px solid var(--line)}
    .top-logo img{width:100%;height:100%;object-fit:cover;display:none}

    /* Hide Privacy button on mobile */
    @media (max-width: 800px) {
      #awayBtn { display: none !important; }
    }

    /* LAYOUT */
    .container{padding:18px;max-width:1180px}
    .card{backdrop-filter: blur(10px);background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow-sm);transition:background .3s ease,border-color .3s ease,box-shadow .3s ease}
    .pad{padding:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap}

    /* CALENDAR */
    .calendar-page{display:grid;gap:12px}
    .calendar-card{display:grid;gap:12px}
    .calendar-header{display:flex;align-items:center;justify-content:space-between}
    .calendar-header h2{margin:0;font-size:20px;font-weight:800}
    .calendar-nav{display:flex;gap:8px}
    .calendar-nav .btn{height:32px;padding:0 12px;border-radius:999px;font-size:12.5px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .calendar-day{display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted);text-transform:uppercase;font-size:11px}
    .calendar-cell{border:1px solid var(--line);border-radius:12px;min-height:110px;padding:10px;display:grid;align-content:flex-start;gap:6px;background:var(--surface);position:relative;box-shadow:var(--glass-ring)}
    .calendar-cell.today{border-color:rgba(1,250,191,.6);box-shadow:0 0 0 2px rgba(1,250,191,.18) inset, var(--glass-ring)}
    .calendar-date{font-weight:800;font-size:14px}
    .calendar-date.muted{color:var(--muted);font-weight:600}
    .calendar-events{display:grid;gap:6px}
    .calendar-event{border-radius:10px;padding:6px 8px;background:linear-gradient(135deg,rgba(1,250,191,.16),rgba(0,181,255,.12));border:1px solid rgba(1,250,191,.35);font-size:12.5px;font-weight:600;cursor:pointer;transition:transform .12s ease,box-shadow .2s ease}
    .calendar-event:hover{transform:translateY(-1px);box-shadow:var(--shadow-sm)}
    .calendar-event[data-type="project"]{background:linear-gradient(135deg,rgba(59,130,246,.14),rgba(14,116,144,.12));border-color:rgba(59,130,246,.35)}
    .calendar-sidebar{display:grid;gap:10px}
    .event-list{display:grid;gap:10px}
    .event-card{border:1px solid var(--line);border-radius:12px;padding:12px;background:var(--surface);box-shadow:var(--glass-ring);display:grid;gap:8px}
    .event-card h3{margin:0;font-size:15px;font-weight:800}
    .event-meta{color:var(--muted);font-size:12.5px}
    .event-actions{display:flex;gap:8px;flex-wrap:wrap}
    .calendar-layout{display:grid;grid-template-columns:2fr 1fr;gap:12px}
    @media(max-width:1100px){.calendar-layout{grid-template-columns:1fr}}
    @media(max-width:640px){.calendar-grid{grid-template-columns:repeat(2,1fr)}.calendar-day{display:none}}

    /* BANNER */
    .welcome{padding:18px;border-radius:16px;background:var(--banner-grad);color:#001014;box-shadow:var(--shadow-md)}
    .welcome h2{margin:0 0 2px 0;font-size:22px;font-weight:800}
    .welcome p{margin:0;font-weight:600;opacity:.95;font-size:13.5px}

    /* STATS */
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .stat{display:flex;align-items:center;gap:10px;padding:14px;border:1px solid var(--line);border-radius:12px;background:var(--surface)}
    .badge{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;box-shadow:var(--glass-ring)}
    .val{font-weight:800;font-size:18px}
    .muted{color:var(--muted)}

    /* QUICK LINKS ‚Äî refined */
    .section-title{font-weight:800;margin-bottom:8px;font-size:14px}
    .links-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:980px){ .links-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){ .links-grid{grid-template-columns:1fr}}
    .ql-card{
      position:relative;border-radius:14px;border:1.5px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.78),rgba(255,255,255,.55));
      min-height:118px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;
      transition:transform .16s ease, box-shadow .16s ease, border-color .2s ease, background .3s ease;
      box-shadow:var(--shadow-sm);
      text-decoration:none;color:inherit; overflow:hidden;
    }
    [data-theme="dark"] .ql-card{background:linear-gradient(180deg,rgba(15,21,32,.9),rgba(15,21,32,.72));}
    .ql-card:hover{transform:translateY(-2px); box-shadow:var(--shadow-md)}
    .ql-card[data-color="red"]{border-color:#ef4444}
    .ql-card[data-color="blue"]{border-color:#3b82f6}
    .ql-card[data-color="green"]{border-color:#22c55e}
    .ql-card[data-color="yellow"]{border-color:#eab308}
    .ql-card[data-color="purple"]{border-color:#8b5cf6}
    .ql-card .icon-badge{
      width:54px;height:54px;border-radius:14px;display:grid;place-items:center;
      background:linear-gradient(135deg,rgba(1,250,191,.10),rgba(0,181,255,.06));
      box-shadow:var(--glass-ring);
    }
    .ql-title{font-weight:800;font-size:13.5px}
    .ql-ext{position:absolute;left:10px;bottom:8px;font-size:16px;opacity:.6}
    .ql-actions{position:absolute;right:8px;top:8px;display:flex;gap:6px}
    .chip{height:30px;padding:0 10px;border-radius:999px;border:1px solid var(--line);background:transparent;display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:700;font-size:12.5px;transition:background .2s ease,color .2s ease,border-color .2s ease}
    .chip:hover{background:var(--ink);color:#fff;border-color:var(--ink)}
    .toolbar{display:flex;align-items:center;gap:8px;justify-content:flex-end}

    /* ICONS (outline set) */
    .icon{width:22px;height:22px;display:block;color:currentColor;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

    /* TABLES & FORMS */
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th{color:var(--muted);font-weight:600;text-align:left;padding:6px 10px;font-size:12.5px}
    .table td{background:var(--surface);border:1px solid var(--line);padding:12px 10px;font-size:13.5px}
    .input, select, textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:var(--surface);color:var(--ink);transition:border-color .2s ease, background .3s ease,color .3s ease}
    .input:focus, select:focus, textarea:focus{outline:none;box-shadow:var(--focus);border-color:transparent}
    .search{display:flex;gap:10px;align-items:center}
    .search .input{flex:1}
    .empty{color:var(--muted);text-align:center;padding:20px 0}

    /* SUPPLIERS (full-width frosted tiles) */
    .supplier-list{display:grid;gap:10px}
    .supplier-tile{
      display:grid;grid-template-columns:62px 1fr auto;align-items:center;gap:12px;
      border:1px solid var(--line);background:var(--surface);backdrop-filter: blur(10px);
      border-radius:14px;padding:10px;box-shadow:var(--shadow-sm);
      cursor:pointer;transition:transform .2s ease, box-shadow .3s ease, border-color .2s ease;
    }
    .supplier-tile:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(1,250,191,.2);border-color:rgba(1,250,191,.5)}
    .supplier-logo{width:62px;height:62px;border-radius:12px;overflow:hidden;background:linear-gradient(135deg,rgba(1,250,191,.12),rgba(0,181,255,.08));display:grid;place-items:center;border:1px solid var(--line)}
    .supplier-logo img{max-width:100%;max-height:100%;object-fit:contain}
    .supplier-meta{min-width:0}
    .supplier-name{font-weight:800;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .supplier-url{font-size:12.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .supplier-actions{display:flex;gap:8px}

    /* CONTACT CARDS */
    .contact-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:980px){.contact-grid{grid-template-columns:1fr}}
    .contact-card{
      border:1px solid var(--line);background:var(--surface);border-radius:14px;
      padding:12px;box-shadow:var(--shadow-sm);
      display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px;
      cursor:pointer;transition:transform .16s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .contact-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);border-color:rgba(1,250,191,.4)}
    .contact-name{font-weight:800;font-size:15px}
    .contact-meta{color:var(--muted);font-size:12.5px;margin-top:2px}
    .contact-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn.sm{height:28px;padding:0 10px;font-size:12px;border-radius:8px}

    /* MODALS (scrollable, wide landscape option) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;z-index:50;animation:fade .2s ease}
    [data-theme="dark"] .modal-backdrop{background:rgba(0,0,0,.55)}
    .modal{
      width:min(680px,94vw);
      max-height:90vh;
      display:flex;flex-direction:column;
      backdrop-filter: blur(14px);background:var(--surface);
      border-radius:16px;border:1px solid var(--line);box-shadow:var(--shadow-md);
      transition:background .3s ease,border-color .3s ease
    }
    .modal.wide{ width:min(980px,96vw) }
    .modal header{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .modal header h3{margin:0;font-size:18px}
    .modal .body{padding:14px 16px;display:grid;gap:10px;overflow:auto;flex:1 1 auto}
    .modal .footer{padding:12px 16px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:8px;flex:0 0 auto}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){ .grid-2{grid-template-columns:1fr} }

    .btn{height:34px;padding:0 12px;border-radius:10px;border:1px solid var(--line);background:transparent;cursor:pointer;font-weight:700;font-size:13px;transition:background .2s ease,color .2s ease,border-color .2s ease;display:inline-flex;align-items:center;gap:8px}
    .btn.primary{background:var(--btn);color:var(--btn-ink);border-color:var(--btn)}
    .btn.danger{background:#ef4444;color:#fff;border-color:#ef4444}
    .close-x{cursor:pointer;font-weight:800;color:var(--muted)}
    .hint{color:var(--muted);font-size:12.5px}

    /* ICON PICKER */
    .icon-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
    .icon-option{border:1px solid var(--line);border-radius:12px;background:var(--surface);display:grid;place-items:center;padding:10px;cursor:pointer;transition:transform .12s ease,border-color .2s ease, background .2s ease}
    .icon-option:hover{transform:translateY(-1px)}
    .icon-option.selected{border-color:var(--brand);box-shadow:0 0 0 3px rgba(1,250,191,.25) inset}

    /* AWAY MODE 2.0 */
    .away{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:100;
      background: radial-gradient(ellipse at 30% 20%, rgba(1,250,191,.18), transparent 40%),
                  radial-gradient(ellipse at 70% 80%, rgba(0,181,255,.16), transparent 40%), var(--bg);
      backdrop-filter: blur(22px);
    }
    .away canvas{position:absolute;inset:0;opacity:.6}

    /* TOASTS */
    .toast-wrap{position:fixed;right:18px;bottom:18px;display:grid;gap:8px;z-index:9999}
    .toast{min-width:200px;max-width:420px;padding:10px 14px;border-radius:12px;background:var(--ink);color:#fff;box-shadow:var(--shadow-md);font-weight:700;display:flex;align-items:center;gap:8px;opacity:0;transform:translateY(8px) scale(.98);transition:opacity .18s ease,transform .18s ease}
    .toast.show{opacity:1;transform:translateY(0) scale(1)}
    .toast.success{background:linear-gradient(90deg,#01FABF,#00B5FF);color:#001014}
    .toast.warn{background:#ef4444}
    .toast .close{margin-left:auto;cursor:pointer;opacity:.8}
    .away .panel{position:relative;width:min(560px,92vw);padding:28px;border-radius:18px;backdrop-filter: blur(22px);background:var(--surface);border:1px solid var(--line);box-shadow:var(--shadow-md);text-align:center}
    .away .mark{width:64px;height:64px;border-radius:16px;margin:0 auto 12px auto;background:#0f172a;color:#01FABF;display:grid;place-items:center;font-weight:900;box-shadow:inset 0 0 0 3px rgba(1,250,191,.35);overflow:hidden}
  .away .confirm{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:120}
  .away .confirm .check{width:120px;height:120px;border-radius:999px;background:linear-gradient(135deg,#22c55e,#10b981);display:grid;place-items:center;color:#fff;font-size:46px;transform:scale(.6);opacity:0;transition:transform .35s cubic-bezier(.2,.9,.2,1),opacity .25s ease}
  .away.show-confirm .confirm{display:flex}
  .away.show-confirm .confirm .check{transform:scale(1);opacity:1}
    .away .mark img{width:100%;height:100%;object-fit:cover;display:none}
    [data-theme="dark"] .away .mark{background:#01FABF;color:#001014;box-shadow:inset 0 0 0 3px rgba(0,16,20,.35)}
    .away h1{margin:0 0 6px 0;font-size:24px}
    .away p{margin:0 0 10px 0;color:var(--muted)}
    .pin-wrap{display:grid;gap:10px;justify-items:center;margin-top:6px}
    .pin-input{letter-spacing:8px;text-align:center;font-size:18px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:var(--surface);width:220px}
    .keypad{display:grid;grid-template-columns:repeat(3,70px);gap:10px;justify-content:center}
    .keypad button{height:48px;border-radius:12px;border:1px solid var(--line);background:var(--surface);font-weight:800;cursor:pointer}
    .shake{animation:shake .35s ease}
    @keyframes shake{10%, 90% { transform: translateX(-2px); }20%, 80% { transform: translateX(4px); }30%, 50%, 70% { transform: translateX(-6px); }40%, 60% { transform: translateX(6px); }}

    /* RESPONSIVE */
    /* hide menu by default, allow responsive rule to override on small screens */
    .menu{display:none}
    @media (max-width:980px){
      .app{grid-template-columns:1fr}
      .sidebar{position:fixed;transform:translateX(-100%);z-index:60;width:260px}
      .sidebar{transition:transform .28s ease}
      .sidebar.open{transform:translateX(0)}
      .topbar .menu{display:block}
      .stats{grid-template-columns:1fr 1fr}
      .icon-grid{grid-template-columns:repeat(5,1fr)}
    }
  @media (max-width:700px){ .icon-grid{grid-template-columns:repeat(4,1fr)} }

    /* Mobile touch targets and small-screen adjustments */
    @media (max-width:980px){
      .icon-btn, .btn, .chip { min-height:44px; padding:10px 12px; }
      .nav a { padding:12px; border-radius:12px; }
      .top-actions { gap:6px; }
      .keypad button { height:56px; font-size:18px; }
    }
    @media (max-width:480px){
      /* hide less important info to save space on very small devices */
      #autosaveIndicator{display:none}
      .top-actions .divider{display:none}
      .page-title{display:none}
    }

    /* KEYFRAMES */
    @keyframes fade{from{opacity:0}to{opacity:1}}

    /* TOAST */
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:var(--ink);color:#fff;padding:10px 14px;border-radius:999px;box-shadow:var(--shadow-md);z-index:120;opacity:0;pointer-events:none;transition:opacity .2s ease}
    .toast.show{opacity:1}
    /* Drag & drop visuals for sidebar */
    .nav a.dragging{opacity:.4}
    .nav a.drop-target{outline:2px dashed rgba(1,250,191,.5);}
    /* Mobile close button inside the sidebar */
    .close-mobile{display:none}
    @media (max-width:980px){
      .close-mobile{display:block;position:absolute;top:12px;right:12px;background:transparent;border:none;font-size:20px;cursor:pointer;color:var(--muted)}
      .sidebar{padding-top:40px}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="logo">
        <div class="logo-mark" id="logoMark"><span>EW</span><img id="logoMarkImg" alt=""></div>
        <div class="logo-title">Elite HQ</div>
      </div>
      <nav class="nav" id="nav">
  <a href="#/dashboard" data-route="dashboard" class="active"><span class="ico" data-ico="home"></span>Dashboard</a>
  <a href="#/contacts" data-route="contacts"><span class="ico" data-ico="user"></span>Contacts</a>
  <a href="#/projects" data-route="projects"><span class="ico" data-ico="folder"></span>Projects</a>
  <a href="#/calendar" data-route="calendar"><span class="ico" data-ico="calendar"></span>Calendar</a>
  <a href="#/suppliers" data-route="suppliers"><span class="ico" data-ico="shield"></span>Suppliers</a>
  <a href="#/referrals" data-route="referrals"><span class="ico" data-ico="gift"></span>Referrals</a>
  <div class="nav-group" data-group="email">
    <button class="nav-group-header" type="button" aria-expanded="false">
      <span class="left"><span class="ico" data-ico="mail"></span><span>Email</span></span>
      <span class="chev">‚ñæ</span>
    </button>
    <div class="nav-sub" id="navEmail">
      <a href="#/create-email" data-route="create-email" class="sub"><span class="ico" data-ico="mail"></span>Create Email</a>
      <a href="#/templates" data-route="templates" class="sub"><span class="ico" data-ico="doc"></span>Templates</a>
    </div>
  </div>
  <div class="nav-group" data-group="quotes">
    <button class="nav-group-header" type="button" aria-expanded="false">
      <span class="left"><span class="ico" data-ico="doc"></span><span>Quotes</span></span>
      <span class="chev">‚ñæ</span>
    </button>
    <div class="nav-sub" id="navQuotes">
      <a href="#/quote" data-route="quote" class="sub"><span class="ico" data-ico="doc"></span>New Quote</a>
      <a href="#/remote-quote" data-route="remote-quote" class="sub"><span class="ico" data-ico="doc"></span>Remote Quote Form</a>
    </div>
  </div>
  <a href="#/optimiser" data-route="optimiser"><span class="ico" data-ico="wrench"></span>Cut Optimiser</a>
  <div class="nav-group" data-group="signatures">
    <button class="nav-group-header" type="button" aria-expanded="false">
      <span class="left"><span class="ico" data-ico="doc"></span><span>Signatures</span></span>
      <span class="chev">‚ñæ</span>
    </button>
    <div class="nav-sub" id="navSignatures">
      <a href="#/signatures" data-route="signatures" class="sub"><span class="ico" data-ico="doc"></span>In-Person Signatures</a>
      <a href="#/remote-sign" data-route="remote-sign" class="sub"><span class="ico" data-ico="doc"></span>Remote Signatures</a>
    </div>
  </div>
      <a href="#/settings" data-route="settings"><span class="ico" data-ico="settings"></span>Settings</a>
      </nav>
        <button class="close-mobile" id="closeMobileBtn" aria-label="Close menu">‚úï</button>
    </aside>

    <main class="main">
      <div class="topbar">
        <button class="btn menu" id="menuBtn">‚ò∞</button>
        <div class="crumb" id="crumb">Dashboard</div>
        <div class="page-title" id="pageTitle"></div>
        <div class="spacer"></div>
        <div class="top-actions">
          <!-- Removed topbar logo as requested -->
          <!-- Upload moved to Settings page -->
          <button class="icon-btn" id="awayBtn" title="Away Mode" onclick="openAwayOverlay()" aria-haspopup="dialog" aria-controls="awayOverlay" aria-expanded="false"><span class="ico" data-ico="shield"></span><span>Privacy</span></button>
          <!-- Autosave indicator -->
          <div id="autosaveIndicator" class="muted" style="font-size:13px;padding:0 8px;display:flex;align-items:center;gap:8px">Autosave: <span id="autosaveState">‚Äî</span></div>
          <!-- Backup status -->
          <div id="backupIndicator" class="muted" style="font-size:13px;padding:0 8px;display:flex;align-items:center;gap:8px">Last backup: <span id="lastBackup">‚Äî</span></div>
          <button class="icon-btn" id="backupNowBtn" title="Backup now" style="height:34px;">Backup now</button>
          <div class="divider"></div>
          <div class="switch" id="modeSwitch" role="switch" aria-checked="false" tabindex="0" title="Toggle theme">
            <div class="knob"></div>
          </div>
        </div>
      </div>

      <div class="container" id="view"><!-- routed content injects here --></div>
    </main>
  </div>
  <!-- Toast container -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <!-- Away Mode 2.0 -->
  <div class="away" id="awayOverlay" aria-hidden="true">
    <canvas id="particles"></canvas>
    <div class="panel">
      <div class="mark"><span>EW</span><img id="awayLogoImg" alt=""></div>
      <h1>Elite HQ ‚Äî Secured</h1>
      <p>Enter your PIN to unlock.</p>
      <div class="pin-wrap">
        <input id="pinInput" class="pin-input" type="password" inputmode="numeric" autocomplete="one-time-code" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" />
        <div class="keypad" id="keypad"></div>
        <small class="muted">PIN: 6 digits ‚Ä¢ Desktop: type directly ‚Ä¢ Mobile: use keypad</small>
      </div>
    </div>
      <script>
        // Small UI glue for manual backup and status display
        (function(){
          function toast(msg, kind='success'){
            const t = document.createElement('div'); t.className = 'toast show ' + (kind==='success' ? 'success' : 'warn');
            t.textContent = msg;
            const close = document.createElement('span'); close.textContent = '√ó'; close.className='close'; close.style.marginLeft='12px'; close.onclick = ()=>{ t.remove() };
            t.appendChild(close);
            document.body.appendChild(t);
            setTimeout(()=> t.remove(), 5500);
          }

          const lastEl = document.getElementById('lastBackup');
          const btn = document.getElementById('backupNowBtn');
          const setLast = (ts) => { lastEl.textContent = ts ? new Date(ts).toLocaleString() : '‚Äî' };

          // Try to read lastBackup timestamp from FirebaseHelpers if available
          async function refreshLast(){
            try{
              if(window.FirebaseHelpers && window.FirebaseHelpers.loadHQData){
                const d = await window.FirebaseHelpers.loadHQData();
                if(d && d.updatedAt) setLast(d.updatedAt);
                else setLast(null);
              }
            }catch(err){ console.debug('refreshLast failed',err); }
          }

          btn.addEventListener('click', async ()=>{
            try{
              btn.disabled = true; btn.textContent = 'Backing up...';
              if(window.manualBackup){
                const res = await window.manualBackup();
                await refreshLast();
                toast('Backup complete');
              } else if(window.FirebaseHelpers && window.FirebaseHelpers.saveHQData){
                await window.FirebaseHelpers.saveHQData();
                await refreshLast();
                toast('Backup complete');
              } else {
                toast('Backup helper not ready', 'warn');
              }
            }catch(err){
              console.error('Backup failed',err);
              toast('Backup failed: '+(err && err.message?err.message:err), 'warn');
            }finally{ btn.disabled=false; btn.textContent='Backup now' }
          });

          // Refresh on load and periodically
          window.addEventListener('load', ()=>{ setTimeout(refreshLast,1200); setInterval(refreshLast,60*1000); });
          // expose a helper to update UI from FirebaseHelpers
          window.__setLastBackupUI = (ts)=> setLast(ts);
        })();
      </script>
  </div>

  <!-- Modals -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true"></div>
  <!-- Email templates removed -->
  <!-- Toast -->
  <div class="toast" id="toast">Copied</div>

  <script>
    /************ Theme ************/
    const THEME_KEY = 'ew_theme';
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      document.getElementById('modeSwitch').setAttribute('aria-checked', String(t==='dark'));
    }
    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY) || 'light';
      applyTheme(saved);
    }
    initTheme();
    const switchEl = document.getElementById('modeSwitch');
    function toggleTheme(){
      const cur = document.documentElement.getAttribute('data-theme')==='dark' ? 'dark' : 'light';
      const next = cur==='dark' ? 'light' : 'dark';
      localStorage.setItem(THEME_KEY, next);
      applyTheme(next);
    }
    switchEl.addEventListener('click', toggleTheme);
    switchEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleTheme(); } });

    /************ Simple Store (localStorage) ************/
    const Store = {
      get(key, fallback){
        try { return JSON.parse(localStorage.getItem(key)) ?? fallback } catch { return fallback }
      },
      set(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
    };
    const db = {
      links: Store.get('ew_links',[
        { id: crypto.randomUUID(), title:'Gmail', url:'https://mail.google.com', icon:'mail', color:'neutral' },
        { id: crypto.randomUUID(), title:'Calendar', url:'https://calendar.google.com', icon:'calendar', color:'neutral' },
      ]),
      contacts: Store.get('ew_contacts',[]),
      projects: Store.get('ew_projects',[]),
      suppliers: Store.get('ew_suppliers',[]),
      calendarEvents: Store.get('ew_calendar',[])
    };
    function persist(){
      Store.set('ew_links', db.links);
      Store.set('ew_contacts', db.contacts);
      Store.set('ew_projects', db.projects);
      Store.set('ew_suppliers', db.suppliers);
      Store.set('ew_calendar', db.calendarEvents);
      // Mirror local changes to Firestore for cross-device backups (safe no-op if Firebase not ready)
      try{
        // simple debounce to avoid frequent writes; only update the lastBackupAt when we actually call saveHQData
        if(!window._ew_lastBackupAt) window._ew_lastBackupAt = 0;
        const now = Date.now();
        if(now - window._ew_lastBackupAt > 3000){
          if(window.FirebaseHelpers && typeof window.FirebaseHelpers.saveHQData === 'function'){
            // mark the time now to debounce subsequent saves
            window._ew_lastBackupAt = now;
            // fire-and-forget backup; merge on server via setDoc in saveHQData
            window.FirebaseHelpers.saveHQData({
              links: db.links,
              contacts: db.contacts,
              projects: db.projects,
              suppliers: db.suppliers,
              calendarEvents: db.calendarEvents
            }).then(()=>{
              console.info('Auto-backup: elitehq/settings saved');
            }).catch(err=>{
              console.warn('Auto-backup failed', err);
              // if it failed, reset the lastBackupAt so we can retry sooner
              window._ew_lastBackupAt = 0;
            });
          }
        }
      }catch(e){ console.warn('Auto-backup attempt threw', e); }
    }

    /************ Icons (outline, inline) ************/
    const Icons = {
      mail: 'M4 4h16v16H4z M4 6l8 6 8-6',
      calendar: 'M4 5h16v14H4z M8 3v4 M16 3v4 M4 9h16',
      user: 'M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10 M4 20a8 6 0 0 1 16 0',
      link: 'M10 14L8 16a4 4 0 1 1-6-6l2-2 M14 10l2-2a4 4 0 0 1 6 6l-2 2 M9 12h6',
      globe: 'M12 2a10 10 0 1 0 0 20 M2 12h20 M12 2a15 15 0 0 1 0 20 M12 2a15 15 0 0 0 0 20',
      folder: 'M3 7h7l2 3h9v9H3z',
      file: 'M6 2h9l5 5v15H6z M15 2v6h6',
      phone: 'M6 2h12v20H6z M12 18.5a.5.5 0 1 0 0 1 M9 4h6v10H9z',
      camera: 'M4 7h16v10H4z M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0-8 0 M7 7V5h4v2',
      settings: 'M12 8a4 4 0 1 0 0 8 M4 12h4 M16 12h4 M12 4v4 M12 16v4',
      home: 'M3 10l9-7 9 7v10H3z M9 21v-6h6v6',
      bell: 'M6 10a6 6 0 0 1 12 0v6H6z M10 20a2 2 0 0 0 4 0',
      star: 'M12 3l3 6 7 1-5 5 1 7-6-3-6 3 1-7-5-5 7-1z',
      map: 'M9 4l6-2 6 2v16l-6-2-6 2-6-2V2z M15 10a2 2 0 1 0 0 .01',
      credit: 'M3 6h18v12H3z M3 9h18',
      shield: 'M12 2l8 4v6c0 5-4 8-8 10-4-2-8-5-8-10V6z',
      clock: 'M12 3a9 9 0 1 0 0 18 M12 7v6l4 2',
      pin: 'M12 22s-6-5.2-6-10a6 6 0 1 1 12 0c0 4.8-6 10-6 10z M12 12a2.5 2.5 0 1 0 0 .01',
      doc: 'M6 3h9l3 3v15H6z M15 3v6h6',
      image: 'M3 5h18v14H3z M9 11a2 2 0 1 0 0 .01 M21 17l-6-6-5 5-3-3-4 4',
      play: 'M5 3l16 9-16 9z',
      chat: 'M4 5h16v10H7l-3 4z',
      download: 'M12 3v10 M7 11l5 5 5-5 M5 19h14',
      upload: 'M12 21V11 M7 13l5-5 5 5 M5 5h14',
      wrench: 'M21 7a7 7 0 0 1-9 9l-6 6-3-3 6-6a7 7 0 0 1 9-9z',
      copy: 'M9 3h10v10H9z M5 7h10v10H5z'
    };
    const ICON_KEYS = Object.keys(Icons);
    function renderIcon(key){
      const d = Icons[key] || Icons['link'];
      return `<svg class="icon" viewBox="0 0 24 24"><path d="${d.replace(/\s+/g,' ')}"/></svg>`;
    }
    function hydrateInlineIcons(){
      document.querySelectorAll('[data-ico]').forEach(n=> n.innerHTML = renderIcon(n.dataset.ico));
    }

    /************ Utilities ************/
    const $ = (sel,root=document)=>root.querySelector(sel);
    const $$ = (sel,root=document)=>[...root.querySelectorAll(sel)];
    function el(tag, attrs={}, children=[]){
      const n = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if(k==='class') n.className=v;
        else if(k==='html') n.innerHTML=v;
        else if(k.startsWith('on')) n.addEventListener(k.slice(2),v);
        else n.setAttribute(k,v);
      }
      children.forEach(c=> n.append(c));
      return n;
    }
    function currency(n){ return new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP',maximumFractionDigits:0}).format(+n||0).replace('¬£','¬£'); }

    /* tiny toast + clipboard */
    function showToast(msg='Copied'){
      const t = document.getElementById('toast'); if(!t) return;
      t.textContent = msg; t.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>t.classList.remove('show'), 1200);
    }
    async function copyText(txt){
      try{ await navigator.clipboard.writeText(txt||''); showToast('Copied'); }
      catch(e){ showToast('Copy failed'); }
    }

    /************ Calendar Helpers ************/
    const calendarState = { viewDate: new Date() };
    const MONTH_FORMAT = new Intl.DateTimeFormat('en-GB',{month:'long',year:'numeric'});
    const DAY_FORMAT = new Intl.DateTimeFormat('en-GB',{day:'numeric',month:'short',year:'numeric'});
    function parseISODate(str){
      if(!str) return null;
      const [y,m,d] = str.split('-').map(Number);
      if(!y || !m || !d) return null;
      const date = new Date(y, m-1, d);
      if(Number.isNaN(date.getTime())) return null;
      return date;
    }
    function toStartOfDay(date){
      if(!date) return null;
      return new Date(date.getFullYear(), date.getMonth(), date.getDate());
    }
    function isSameDay(a,b){
      if(!a || !b) return false;
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }
    function eventRange(ev){
      const start = parseISODate(ev.date);
      const end = parseISODate(ev.endDate) || start;
      if(!start) return null;
      if(end && end < start){ return { start, end: start }; }
      return { start, end: end || start };
    }
    function eventOccursOn(ev, day){
      const range = eventRange(ev);
      if(!range) return false;
      const start = toStartOfDay(range.start);
      const end = toStartOfDay(range.end);
      const target = toStartOfDay(day);
      return target >= start && target <= end;
    }
    function formatEventRange(ev){
      const range = eventRange(ev);
      if(!range) return 'Date to be announced';
      if(isSameDay(range.start, range.end)) return DAY_FORMAT.format(range.start);
      return `${DAY_FORMAT.format(range.start)} ‚Üí ${DAY_FORMAT.format(range.end)}`;
    }

    /************ Router ************/
  const routes = { dashboard: renderDashboard, contacts: renderContacts, projects: renderProjects, calendar: renderCalendar, suppliers: renderSuppliers, referrals: renderReferrals, 'create-email': renderEmail, templates: renderTemplates, quote: renderQuote, optimiser: renderOptimiser, signatures: renderSignatures, 'remote-sign': renderRemoteSign, 'remote-quote': renderRemoteQuote, settings: renderSettings };

    // Local embed helper: fetch a local tool HTML and inject its content into the SPA view
    async function embedLocal(relativePath, title){
      const view = document.getElementById('view');
      view.innerHTML = '';
      const card = el('div',{class:'card pad'},[]);
      card.append(el('div',{class:'section-title',html:title||''}));
      const wrap = el('div',{},[]);
      view.appendChild(card);
      try{
        const res = await fetch(relativePath);
        const txt = await res.text();
        // Extract body content
        const m = txt.match(/<body[^>]*>([\s\S]*)<\/body>/i);
        const content = m ? m[1] : txt;
        wrap.innerHTML = content;
        card.append(wrap);
        // Execute any inline scripts by creating script elements
        const scripts = wrap.querySelectorAll('script');
        scripts.forEach(s=>{
          const sc = document.createElement('script');
          if(s.src) sc.src = s.src;
          else sc.textContent = s.textContent;
          document.body.appendChild(sc);
          sc.onload = () => sc.remove();
        });
      }catch(e){ wrap.innerHTML = `<div class="hint">Failed to load tool: ${e.message}</div>`; card.append(wrap); }
      return card;
    }

    // Local inline Tools (replace iframe embeds) ‚Äî lightweight implementations
    function renderQuote(){
      const appView = document.getElementById('view');
      appView.innerHTML = '';
      const container = el('div',{class:'card pad'});

      const markup = `
        <style>
          /* Quoter styles (scoped minimal) */
          .q-body{ font-family: Arial, sans-serif; background:transparent; color:var(--ink); margin:0; padding:0 }
          .q-card{ background:#fff; border-radius:8px; padding:20px; margin-bottom:20px; box-shadow:0 2px 6px rgba(0,0,0,0.06) }
          .q-card h2{ color:#00a884; font-size:1.15em; margin-top:0 }
          .q-form-group{ margin-bottom:12px }
          .q-form-group label{ display:block; margin-bottom:4px; font-size:0.9em }
          .q-input, .q-textarea, .q-select{ width:100%; padding:10px; font-size:1em; border:1px solid #ccc; border-radius:4px; box-sizing:border-box }
          .q-textarea{ min-height:80px }
          .q-btn{ background:#00a884; color:#fff; padding:12px 18px; font-size:1em; border:none; border-radius:6px; cursor:pointer }
          .q-btn:hover{ background:#008f72 }
          .q-modal{ display:none; position:fixed; z-index:1200; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5) }
          .q-modal .q-modal-content{ background:#fff; margin:8% auto; border-radius:10px; width:90%; max-width:560px; box-shadow:0 4px 12px rgba(0,0,0,0.12); overflow:hidden }
          .q-modal-header{ background:#00a884; color:#fff; padding:12px; font-weight:bold; text-align:center }
          .q-modal-body{ padding:20px }
          .q-close{ float:right; font-size:22px; font-weight:bold; color:#fff; cursor:pointer }
        </style>

        <div class="q-body">
          <!-- logo removed intentionally -->

          <form id="quoteForm">
            <div class="q-card">
              <h2>Client Info</h2>
              <div class="q-form-group"><label>Name</label><input class="q-input" type="text" id="clientName" required></div>
              <div class="q-form-group"><label>Email</label><input class="q-input" type="email" id="clientEmail"></div>
              <div class="q-form-group"><label>Phone</label><input class="q-input" type="text" id="clientPhone"></div>
              <div class="q-form-group"><label>Address</label><textarea class="q-textarea" id="clientAddress"></textarea></div>
            </div>

            <div class="q-card">
              <h2>Vinyl Areas</h2>
              <div id="areas"></div>
              <button type="button" class="q-btn" id="addAreaBtn">+ Add Area</button>
            </div>

            <div class="q-card">
              <h2>Job Details</h2>
              <div class="q-form-group"><label>Estimated Hours</label><input class="q-input" type="number" id="jobHours" step="0.1"></div>
              <div class="q-form-group"><label>Accommodation Nights</label><input class="q-input" type="number" id="accomNights"></div>
              <div class="q-form-group"><label>EV Charge Cost (¬£)</label><input class="q-input" type="number" id="travelBuffer" step="0.01"></div>
              <div class="q-form-group"><label>Repairs</label>
                <select id="repairs" class="q-select"><option>None</option><option>Low</option><option>Medium</option><option>High</option></select>
              </div>
              <div class="q-form-group"><label>Extra Charges (¬£)</label><input class="q-input" type="number" id="extraCharges" step="0.01"></div>
            </div>

            <div class="q-card">
              <h2>Discount</h2>
              <div class="q-form-group"><label>Discount %</label><input class="q-input" type="number" id="discountPercent" step="1"></div>
              <div class="q-form-group"><label>Discount Name</label><input class="q-input" type="text" id="discountName"></div>
            </div>

            <div class="q-card">
              <h2>Notes</h2>
              <textarea class="q-textarea" id="notes"></textarea>
            </div>

            <div style="text-align:left"><button type="button" class="q-btn" id="previewBtn">Preview Quote</button></div>
          </form>

          <div id="quoteModal" class="q-modal"><div class="q-modal-content"><div class="q-modal-header">Quote Preview<span class="q-close" id="closePreview">&times;</span></div><div class="q-modal-body"><div id="quotePreview"></div><br><button class="q-btn" id="saveEmailBtn">Save & Email</button></div></div></div>

          <div id="emailModal" class="q-modal"><div class="q-modal-content"><div class="q-modal-header">Email Status<span class="q-close" id="closeEmailModalBtn">&times;</span></div><div class="q-modal-body"><div id="emailStatus"></div><br><button class="q-btn" id="emailModalCloseBtn">Close</button></div></div></div>
        </div>
      `;

      container.innerHTML = markup;
      appView.appendChild(container);

      // Inject script to wire behavior (scoped to this rendered markup)
      const scriptContent = `(function(){
  let lastTotal = 0;
  let lockedDeposit = 0;

  function addArea(){
    const container = document.getElementById('areas');
    const idx = container.children.length + 1;
    const div = document.createElement('div');
    div.className = 'q-form-group';
    div.style.borderBottom = '1px solid #eee';
    div.style.paddingBottom = '10px';
    div.style.marginBottom = '10px';
    div.innerHTML = '<label>Area ' + idx + ' Label</label>' +
      '<input class="q-input" type="text" name="areaLabel' + idx + '" required>' +
      '<label>Linear Metres</label>' +
      '<input class="q-input" type="number" name="areaLm' + idx + '" step="0.01" required>' +
      '<label>Quantity</label>' +
      '<input class="q-input" type="number" name="areaQty' + idx + '" value="1" required>' +
      '<label>Cost per LM (¬£)</label>' +
      '<input class="q-input" type="number" name="areaCost' + idx + '" step="0.01" required>' +
      '<label>Vinyl Product Code</label>' +
      '<input class="q-input" type="text" name="areaCode' + idx + '">';
    container.appendChild(div);
  }

  function previewQuote(){
    const total = lastTotal ? lastTotal.toFixed(2) : 'Calculated on Save';
    const deposit = lockedDeposit ? lockedDeposit.toFixed(2) : 'Calculated on Save';
    document.getElementById('quotePreview').innerHTML = '<p><strong>Quote will be saved & emailed.</strong></p>' +
      '<p><strong>Final Total:</strong> ¬£' + total + '</p>' +
      '<p><strong>Deposit Required:</strong> ¬£' + deposit + '</p>' +
      '<small>(Full breakdown is included in your internal PDF & email)</small>';
    document.getElementById('quoteModal').style.display = 'block';
  }

  function submitQuote(){
    document.getElementById('quoteModal').style.display = 'none';
    document.getElementById('emailModal').style.display = 'block';
    document.getElementById('emailStatus').innerText = '‚è≥ Sending...';

    const areaDivs = document.querySelectorAll('#areas .q-form-group');
    let areas = [];
    areaDivs.forEach(function(div, i){
      const label = div.querySelector("input[name='areaLabel" + (i+1) + "']").value;
      const lm = div.querySelector("input[name='areaLm" + (i+1) + "']").value;
      const qty = div.querySelector("input[name='areaQty" + (i+1) + "']").value;
      const cost = div.querySelector("input[name='areaCost" + (i+1) + "']").value;
      const code = div.querySelector("input[name='areaCode" + (i+1) + "']").value;
      areas.push({ label: label, lm: lm, qty: qty, costPerLM: cost, code: code });
    });

    fetch('https://script.google.com/macros/s/AKfycbwDtfMaObFsfAgs2jMSGa93EKsljS6U18oE04BH5KqdPAjqYfMpHX7GL-u8AReEzus/exec', {
      method: 'POST',
      body: new URLSearchParams({
        clientName: document.getElementById('clientName').value,
        clientEmail: document.getElementById('clientEmail').value,
        clientPhone: document.getElementById('clientPhone').value,
        clientAddress: document.getElementById('clientAddress').value,
        jobHours: document.getElementById('jobHours').value,
        accomNights: document.getElementById('accomNights').value,
        travelBuffer: document.getElementById('travelBuffer') ? document.getElementById('travelBuffer').value : '',
        repairs: document.getElementById('repairs').value,
        extraCharges: document.getElementById('extraCharges').value,
        discountPercent: document.getElementById('discountPercent').value,
        discountName: document.getElementById('discountName').value,
        notes: document.getElementById('notes').value,
        areas: JSON.stringify(areas)
      })
    })
    .then(function(res){ return res.json(); })
    .then(function(res){
      if(res.success){
        var expiry = new Date(); expiry.setDate(expiry.getDate()+30); var expiryDate = expiry.toLocaleDateString('en-GB');
        var clientName = document.getElementById('clientName').value || 'Client';
        var clientEmail = document.getElementById('clientEmail').value || '';
        var quoteRef = res.quoteNumber || '';
        var total = res.totalWithMargin ? res.totalWithMargin.toFixed(2) : '0.00';
        var deposit = res.deposit ? res.deposit.toFixed(2) : '0.00';
        lastTotal = res.totalWithMargin; lockedDeposit = res.deposit;
        var subject = encodeURIComponent('Your Elite Wrapz Quote | ' + quoteRef);
        var body = encodeURIComponent('Hi ' + clientName + '\n\nThank you for considering Elite Wrapz... Final TOTAL: ¬£' + total + ' - Deposit: ¬£' + deposit);
        var mailtoLink = 'mailto:' + clientEmail + '?subject=' + subject + '&body=' + body;
        document.getElementById('emailStatus').innerHTML = '‚úÖ Quote saved & emailed (Ref: ' + quoteRef + ')<br><strong>FINAL TOTAL:</strong> ¬£' + total + '<br><strong>DEPOSIT REQUIRED:</strong> ¬£' + deposit + '<br><br><a href="' + mailtoLink + '" class="q-btn" style="text-decoration:none;">üìß Email Quote to Client</a>';
      } else {
        document.getElementById('emailStatus').innerText = '‚ùå Error: ' + res.error;
      }
    })
    .catch(function(err){ document.getElementById('emailStatus').innerText = '‚ùå Network Error: ' + err.message; });
  }

  function closeModal(){ document.getElementById('quoteModal').style.display='none'; }
  function closeEmailModal(){ document.getElementById('emailModal').style.display='none'; }

  document.getElementById('addAreaBtn').addEventListener('click', addArea);
  document.getElementById('previewBtn').addEventListener('click', previewQuote);
  document.getElementById('saveEmailBtn').addEventListener('click', submitQuote);
  document.getElementById('closePreview').addEventListener('click', closeModal);
  document.getElementById('closeEmailModalBtn').addEventListener('click', closeEmailModal);
  document.getElementById('emailModalCloseBtn').addEventListener('click', closeEmailModal);

  window.__addArea = addArea; window.__previewQuote = previewQuote; window.__submitQuote = submitQuote;
})();
`;

      const s = document.createElement('script'); s.type='text/javascript'; s.textContent = scriptContent;
      document.body.appendChild(s);

  // (no second script to inject)

      return container;
    }

    function renderOptimiser(){
      const view = document.getElementById('view'); view.innerHTML = '';
      const container = el('div',{class:'card pad'},[]);
      container.append(el('div',{class:'section-title',html:'Cut Optimiser'}));

      container.append(el('div',{html:`
        <label>Roll width (mm):</label>
        <input class="input" type="number" id="opt_rollWidth" value="1220" min="50" step="1"/>
        <label>Roll length (mm) <span style="font-size:.85em;font-weight:400;">(leave blank or 0 to auto-calc)</span>:</label>
        <input class="input" type="number" id="opt_rollLength" value="0" min="0" step="1"/>
        <label>Overhang per side (mm):</label>
        <input class="input" type="number" id="opt_overhang" value="50" min="0" step="1"/>
        <label style="display:flex;align-items:center;gap:8px;margin-top:10px;"><input type="checkbox" id="opt_allowRotation" checked /> Allow rotation</label>
        <label>Pieces (width x height [code optional], one per line):</label>
        <textarea class="input" id="opt_pieces" rows="6">600x300 A1
600x300 A2
400x400 A3
200x1200 A4</textarea>
        <div style="display:flex;gap:8px;margin-top:12px"><button class="btn primary" id="opt_run">Optimize & Draw</button><button class="btn" id="opt_export">Export as JPEG</button><button class="btn" id="opt_clear">Clear</button></div>
        <div style="margin-top:12px" id="opt_alerts"></div>
        <div id="opt_stats" class="muted" style="margin-top:8px;display:none"></div>
        <div style="margin-top:12px;border-radius:6px;overflow:auto;background:var(--surface);padding:8px" id="opt_canvasWrap"><canvas id="opt_canvas" width="900" height="2200" style="width:100%;height:auto;border:2px solid var(--brand)"></canvas></div>
        <table class="table" id="opt_summary" style="display:none;margin-top:12px"><thead><tr><th>Code</th><th>Original (mm)</th><th>With Overhang (mm)</th><th>Orientation</th></tr></thead><tbody></tbody></table>
      `}));

  // Inject into the SPA view container so route shows the form
  const appView = document.getElementById('view');
  appView.innerHTML = '';
  appView.appendChild(container);

      // Inline optimiser logic (adapted from provided file)
      function parsePieces(input){
        return input.split('\n').map(line=>{ const m=line.match(/(\d+)\s*x\s*(\d+)(?:\s+([A-Za-z0-9_-]+))?/i); return m?{w:parseInt(m[1]),h:parseInt(m[2]),code:m[3]||""}:null }).filter(Boolean);
      }

      function autoLength(pieces,rollW,overhang,allowRot){
        if(!pieces.length) return 0;
        const dims=pieces.map(p=>({W:p.w+2*overhang,H:p.h+2*overhang}));
        const areaTotal=dims.reduce((a,d)=>a+d.W*d.H,0);
        const maxH=Math.max(...dims.map(d=>d.H));
        let lb=Math.max(maxH,Math.ceil(areaTotal/rollW));
        let ub=dims.reduce((a,d)=>a+d.H,0);
        const test=(H)=>maxRects(pieces,[{x:0,y:0,w:rollW,h:H}],overhang,allowRot).failed.length===0;
        while(!test(ub)) ub=Math.ceil(ub*1.5);
        while(lb<ub){ const mid=Math.floor((lb+ub)/2); if(test(mid)) ub=mid; else lb=mid+1; }
        return ub;
      }

      function maxRects(pieces,freeRects,overhang,allowRot){
        let placed=[],failed=[];
        const score=(f,pw,ph)=>Math.min(Math.abs(f.w-pw),Math.abs(f.h-ph));
        pieces.forEach(p=>{
          let W=p.w+2*overhang,H=p.h+2*overhang,rotW=H,rotH=W,best=null;
          freeRects.forEach(f=>{
            if(W<=f.w&&H<=f.h){let s=score(f,W,H);if(!best||s<best.score)best={x:f.x,y:f.y,w:W,h:H,orientation:"Normal",score:s};}
            if(allowRot&&rotW<=f.w&&rotH<=f.h){let s=score(f,rotW,rotH);if(!best||s<best.score)best={x:f.x,y:f.y,w:rotW,h:rotH,orientation:"Rotated",score:s};}
          });
          if(best){placed.push({...p,...best});freeRects=splitAndPrune(freeRects,best);freeRects=mergeAdjacent(freeRects);}else failed.push(p);
        });
        return {placed,failed,freeRects};
      }

      function splitAndPrune(freeRects,used){
        let newFree=[];
        freeRects.forEach(f=>{
          if(used.x>=f.x+f.w||used.x+used.w<=f.x||used.y>=f.y+f.h||used.y+used.h<=f.y){newFree.push(f);} else {
            if(used.x>f.x)newFree.push({x:f.x,y:f.y,w:used.x-f.x,h:f.h});
            if(used.x+used.w<f.x+f.w)newFree.push({x:used.x+used.w,y:f.y,w:(f.x+f.w)-(used.x+used.w),h:f.h});
            if(used.y>f.y)newFree.push({x:f.x,y:f.y,w:f.w,h:used.y-f.y});
            if(used.y+used.h<f.y+f.h)newFree.push({x:f.x,y:used.y+used.h,w:f.w,h:(f.y+f.h)-(used.y+used.h)});
          }
        });
        return newFree.filter((r,i,self)=>!self.some((o,j)=>j!==i&&r.x>=o.x&&r.y>=o.y&&r.x+r.w<=o.x+o.w&&r.y+r.h<=o.y+o.h));
      }

      function mergeAdjacent(rects){
        let merged=true;
        while(merged){ merged=false; for(let i=0;i<rects.length;i++){ for(let j=i+1;j<rects.length;j++){ const a=rects[i],b=rects[j]; if(a.y===b.y&&a.h===b.h&&(a.x+a.w===b.x||b.x+b.w===a.x)){ rects.splice(j,1); rects[i]={x:Math.min(a.x,b.x),y:a.y,w:a.w+b.w,h:a.h}; merged=true; break; } if(a.x===b.x&&a.w===b.w&&(a.y+a.h===b.y||b.y+b.h===a.y)){ rects.splice(j,1); rects[i]={x:a.x,y:Math.min(a.y,b.y),w:a.w,h:a.h+b.h}; merged=true; break; } } if(merged) break; } }
        return rects;
      }

      function drawRoll(placed,rollW,rollH,overhang,freeRects){
        const canvas=document.getElementById('opt_canvas'),ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
        const scale=Math.min(canvas.width/rollW,canvas.height/rollH);
        ctx.strokeStyle='black';ctx.lineWidth=2;ctx.strokeRect(0,0,rollW*scale,rollH*scale);
        ctx.setLineDash([10,10]);ctx.strokeStyle='red';ctx.lineWidth=1;
        for(let m=1000;m<rollH;m+=1000){let y=m*scale;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(rollW*scale,y);ctx.stroke();ctx.fillStyle='red';ctx.font='12px Inter, Arial';ctx.textAlign='right';ctx.fillText(`${m/1000}m`,rollW*scale-5,y-2);} ctx.setLineDash([]);
        placed.forEach(p=>{ ctx.fillStyle='#e6f4ff'; ctx.fillRect(p.x*scale,p.y*scale,p.w*scale,p.h*scale); ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.strokeRect(p.x*scale,p.y*scale,p.w*scale,p.h*scale); const cx=(p.x+p.w/2)*scale,cy=(p.y+p.h/2)*scale; ctx.textAlign='center'; ctx.textBaseline='middle'; if(p.code){ ctx.fillStyle='#000'; ctx.font='bold 14px Inter, Arial'; ctx.fillText(p.code,cx,cy-8); } ctx.fillStyle='#000'; ctx.font='12px Inter, Arial'; ctx.fillText(`${p.w-2*overhang}x${p.h-2*overhang}`,cx,cy+10); });
      }

      function exportJPEG(){ const canvas=document.getElementById('opt_canvas'); const link=document.createElement('a'); link.download='cut-plan.jpg'; link.href=canvas.toDataURL('image/jpeg',1.0); link.click(); }

      // control wiring
      document.getElementById('opt_run').addEventListener('click', ()=>{
        const rollW = parseInt(document.getElementById('opt_rollWidth').value) || 0;
        const rollLInput = parseInt(document.getElementById('opt_rollLength').value) || 0;
        const overhang = parseInt(document.getElementById('opt_overhang').value) || 0;
        const allowRotation = document.getElementById('opt_allowRotation').checked;
        const pieces = parsePieces(document.getElementById('opt_pieces').value || '');
        const alerts = document.getElementById('opt_alerts'); const stats = document.getElementById('opt_stats'); const summary = document.getElementById('opt_summary'); const tbody = summary.querySelector('tbody');
        alerts.style.display='none'; stats.style.display='none'; summary.style.display='none'; tbody.innerHTML='';
        if(!rollW || !pieces.length){ alerts.style.display='block'; alerts.textContent='Roll width and at least one piece required'; return; }
        const rollH = rollLInput>0?rollLInput:autoLength(pieces,rollW,overhang,allowRotation);
        const res = maxRects(pieces,[{x:0,y:0,w:rollW,h:rollH}],overhang,allowRotation);
        drawRoll(res.placed,rollW,rollH,overhang,res.freeRects);
        const usedArea = res.placed.reduce((a,p)=>a+p.w*p.h,0); const rollArea = rollW*rollH; const wasteArea=Math.max(0,rollArea-usedArea); const lmExact=rollH/1000; const lmRounded=Math.ceil(lmExact); const usedM2=(usedArea/1e6).toFixed(2); const wasteM2=(wasteArea/1e6).toFixed(2); const eff=rollArea>0?Math.round((1-wasteArea/rollArea)*100):100;
        stats.style.display='block'; stats.textContent=`Linear metres required: ${lmExact.toFixed(2)} m (Order: ${lmRounded} m) ¬∑ Used: ${usedM2} m¬≤ ¬∑ Waste: ${wasteM2} m¬≤ ¬∑ Efficiency: ${eff}%`;

    function renderSignatures(){ return embedLocal('/tools/signature_portal.html','In-Person Signatures'); }

        res.placed.forEach(p => {
          tbody.innerHTML += `<tr><td>${p.code||'-'}</td><td>${p.w-2*overhang}x${p.h-2*overhang}</td><td>${p.w}x${p.h}</td><td>${p.orientation}</td></tr>`;
        });
        summary.style.display = 'table';
        if(res.failed.length){
          alerts.style.display = 'block';
          alerts.innerHTML = '‚ö†Ô∏è The following didn‚Äôt fit:<br>' + res.failed.map(p => `${p.w-2*overhang}x${p.h-2*overhang}${p.code ? ' ' + p.code : ''}`).join(', ');
        }
      });

      document.getElementById('opt_export').addEventListener('click', exportJPEG);
      document.getElementById('opt_clear').addEventListener('click', clearAll);

    }

    function renderSignatures(){
      const appView = document.getElementById('view'); appView.innerHTML = '';
      const container = el('div',{class:'card pad'});

      const markup = `
        <style>
          /* In-person Signature page (scoped) */
          .sig-wrap{ font-family: Inter, Arial, sans-serif; color:var(--ink) }
          .sig-head{ text-align:center; margin-bottom:12px }
          .sig-grid{ display:grid; grid-template-columns:1fr; gap:12px }
          .sig-row{ display:flex; gap:12px; flex-wrap:wrap }
          .sig-input{ width:100%; }
          #sig_canvas{ border:2px dashed #444; width:100%; height:220px; touch-action:none; display:block }
          .sig-actions{ display:flex; gap:8px; margin-top:8px }
          .sig-btn{ padding:10px 12px; border-radius:8px; border:1px solid var(--line); background:var(--brand); color:#001014; font-weight:700; cursor:pointer }
          .sig-btn.ghost{ background:transparent; color:var(--muted); border:1px solid var(--line) }
        </style>

        <div class="sig-wrap">
          <div class="sig-head">
            <h2 style="margin:6px 0">Digital Signatures ‚Äî In Person</h2>
            <p class="muted" style="margin:0">Complete the fields and sign below. Download a PDF copy when finished.</p>
            <hr style="margin:12px 0 18px 0">
          </div>

          <div class="sig-grid">
            <div>
              <label class="hint">Agreement Type *</label>
              <select id="sig_agreementType" class="input sig-input">
                <option value="service">Service Agreement</option>
                <option value="payment">Payment Plan Agreement</option>
                <option value="cooling">Cooling-Off Period Waiver</option>
              </select>
            </div>

            <div class="sig-row">
              <div style="flex:1"><label>Full name *</label><input id="sig_clientName" class="input"/></div>
              <div style="width:220px"><label>Contact number *</label><input id="sig_clientContact" class="input"/></div>
            </div>

            <div>
              <label>Email (optional)</label>
              <input id="sig_clientEmail" class="input" type="email" />
            </div>

            <div>
              <label>Address *</label>
              <textarea id="sig_clientAddress" class="input" rows="3"></textarea>
            </div>

            <div>
              <label style="display:block;margin-bottom:6px">Signature *</label>
              <canvas id="sig_canvas"></canvas>
              <div class="sig-actions">
                <button id="sig_clear" class="sig-btn ghost">Clear</button>
                <button id="sig_download" class="sig-btn">Download Signed Acknowledgement</button>
              </div>
            </div>
          </div>
        </div>
      `;

      container.innerHTML = markup; appView.appendChild(container);

      // Load SignaturePad and jsPDF then initialise the view
      const CDN_SIG = 'https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js';
      const CDN_JSPDF = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';

      function loadScript(src){ return new Promise((resolve, reject)=>{
        if(document.querySelector('script[src="'+src+'"]')) return resolve();
        const s = document.createElement('script'); s.src = src; s.onload = () => resolve(); s.onerror = (e)=>reject(e); document.body.appendChild(s);
      }); }

      (async function initSignature(){
        try{
          await loadScript(CDN_SIG);
          await loadScript(CDN_JSPDF);

          const canvas = document.getElementById('sig_canvas');
          function resizeCanvas(){ const ratio = Math.max(window.devicePixelRatio || 1, 1); const w = canvas.offsetWidth; const h = canvas.offsetHeight; canvas.width = Math.round(w * ratio); canvas.height = Math.round(h * ratio); const ctx = canvas.getContext('2d'); ctx.scale(ratio, ratio); }
          window.addEventListener('resize', resizeCanvas); resizeCanvas();

          const signaturePad = new SignaturePad(canvas);

          document.getElementById('sig_clear').addEventListener('click', ()=> signaturePad.clear());

          document.getElementById('sig_download').addEventListener('click', ()=>{
            const agreementType = document.getElementById('sig_agreementType').value;
            const name = document.getElementById('sig_clientName').value.trim();
            const contact = document.getElementById('sig_clientContact').value.trim();
            const email = document.getElementById('sig_clientEmail').value.trim();
            const address = document.getElementById('sig_clientAddress').value.trim();

            if(!agreementType || !name || !contact || !address){ alert('Please fill in all required fields.'); return; }
            if(signaturePad.isEmpty()){ alert('Please provide a signature.'); return; }

            const sigImg = signaturePad.toDataURL('image/png');
            const { jsPDF } = window.jspdf || window.jspdf || {};
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let y = 40;

            let title = '';
            let statement = '';
            let filenamePrefix = 'Elite_Wrapz';
            if(agreementType === 'service'){
              title = 'Service Agreement Acknowledgement';
              statement = 'I, the Customer, confirm that I have read and agree to the terms of the Elite Wrapz Service Agreement.';
              filenamePrefix += '_Service_Agreement';
            } else if(agreementType === 'payment'){
              title = 'Payment Plan Agreement Acknowledgement';
              statement = 'I, the Customer, agree to the terms of the Payment Plan Agreement as outlined by Elite Wrapz.';
              filenamePrefix += '_Payment_Plan_Agreement';
            } else if(agreementType === 'cooling'){
              title = 'Cooling-Off Period Waiver';
              statement = 'I, the Customer, acknowledge my right to a 14-day cooling-off period but request that Elite Wrapz commence work immediately, and I waive this right.';
              filenamePrefix += '_Cooling_Off_Waiver';
            }

            const now = new Date().toLocaleString();

            doc.setFontSize(16); doc.text(title, 40, y); y += 40;
            doc.setFontSize(12); doc.setFont(undefined, 'bold'); doc.text('Client Name:', 40, y); doc.setFont(undefined, 'normal'); doc.text(name, 160, y); y += 18;
            doc.setFont(undefined, 'bold'); doc.text('Contact Number:', 40, y); doc.setFont(undefined, 'normal'); doc.text(contact, 160, y); y += 18;
            if(email){ doc.setFont(undefined, 'bold'); doc.text('Email:', 40, y); doc.setFont(undefined, 'normal'); doc.text(email, 160, y); y += 18; }
            doc.setFont(undefined, 'bold'); doc.text('Address:', 40, y); doc.setFont(undefined, 'normal'); const splitAddress = doc.splitTextToSize(address, pageWidth - 160); doc.text(splitAddress, 160, y); y += splitAddress.length * 14 + 30;
            y += 20;
            doc.setFont(undefined, 'normal'); doc.setFontSize(11); const splitStatement = doc.splitTextToSize(statement, pageWidth - 80); doc.text(splitStatement, 40, y); y += splitStatement.length * 14 + 40;
            doc.setFont(undefined, 'bold'); doc.text('Signature:', 40, y); y += 20;
            doc.addImage(sigImg, 'PNG', 40, y, 250, 80); y += 100;
            doc.setFont(undefined, 'normal'); doc.setFontSize(12); doc.text(`This agreement was signed and agreed to on ${now}.`, 40, y);
            doc.setFontSize(9); doc.text('Elite Wrapz | www.elitewrapz.uk', pageWidth/2, pageHeight - 20, { align: 'center' });

            const safeName = name.replace(/\s+/g, '_');
            const filename = `${filenamePrefix}_${safeName}.pdf`;
            doc.save(filename);
          });

        }catch(e){ console.error('Failed to load signature libraries', e); alert('Signature tools failed to load.'); }
      })();

      return container;
    }

    function renderRemoteSign(){
      // For remote signing we use the same UI but auto-hide admin if params present
      return renderSignatures();
    }

    function renderRemoteQuote(){
      // Inject the exact Remote Quote standalone markup (styles + form) and run its script so it behaves identically
      const appView = document.getElementById('view');
      appView.innerHTML = '';

      const container = el('div',{class:'card pad'});

      // Styles + markup from the provided remote quote page (body only)
      const markup = `
        <style>
          :root{ --primary:#00b3b3; --primary-dark:#008f8f; --grey-light:#f5f5f5; --grey:#ddd; --grey-dark:#999; --font: "Helvetica Neue", Helvetica, Arial, sans-serif; }
          .form-wrapper{ max-width:800px; margin:40px auto; background:white; padding:30px 40px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); font-family:var(--font); color:#333 }
          .form-wrapper h2{ margin-top:0; text-align:center; color:var(--primary-dark) }
          .form-wrapper p{ text-align:center; margin-bottom:25px; font-size:1rem; color:#555 }
          .form-group{ margin-bottom:20px }
          .form-group label{ display:block; margin-bottom:6px; font-weight:bold }
          .form-group input, .form-group select, .form-group textarea{ width:100%; padding:10px; border:1px solid var(--grey); border-radius:4px; font-size:1rem; box-sizing:border-box }
          .form-group textarea{ resize:vertical; min-height:100px }
          .btn-submit{ background:var(--primary); color:white; border:none; padding:14px 30px; font-size:1.1rem; border-radius:4px; cursor:pointer }
          .btn-submit:hover{ background:var(--primary-dark) }
          .required{ color:red }
          .hidden{ display:none }
          /* modal styles (scoped minimally) */
          .rq-modal{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:1200 }
          .rq-modal .modal-content{ background:white; padding:20px; border-radius:8px; max-width:90%; max-height:90%; overflow:auto }
        </style>

        <div class="form-wrapper" id="remote-quote-wrapper">
          <div style="text-align:center; margin:20px 0;"></div>
          <h2>Get Your Quote Without a Visit</h2>
          <p>If you‚Äôre outside the Midlands, or would prefer not to meet face-to-face, simply fill in this form and we‚Äôll provide your quote remotely.</p>

          <form id="remoteQuoteForm">
            <div class="form-group">
              <label for="reason">Why are you filling out this form? <span class="required">*</span></label>
              <select id="reason" name="reason" required>
                <option value="" disabled selected>Select one</option>
                <option value="Out of Area">I live outside the Midlands</option>
                <option value="No Face to Face">I‚Äôd prefer not to have a face-to-face consultation</option>
              </select>
            </div>

            <div class="form-group hidden" id="disclaimerGroup">
              <button type="button" id="viewDisclaimerBtn" style="margin-bottom:10px;" class="btn">View Terms & Conditions</button>
              <label><input type="checkbox" id="ackDisclaimer" name="ackDisclaimer" required> I have read and accept the terms</label>
            </div>

            <div class="rq-modal" id="disclaimerModal"><div class="modal-content"><h2>Terms & Conditions for Remote Quotes</h2><div><ol><li><strong>Colour & Finish Accuracy:</strong> Digital images of vinyl may differ from in-person. Elite Wrapz cannot be held responsible for differences due to screen settings or lighting.</li><li><strong>Samples:</strong> Physical samples available at ¬£1 each plus ¬£5 postage, deducted from your final invoice if you proceed.</li><li><strong>Measurements:</strong> Clients must provide accurate measurements. Errors may incur additional costs.</li><li><strong>Communication:</strong> Clients agree to cooperate in providing details via phone, messages, or email. Lack of communication may cause delays.</li><li><strong>Quote Validity:</strong> Remote quotes are based on supplied info. Discrepancies found on-site may result in extra charges.</li><li><strong>Surface Condition & Repairs:</strong> Without a site visit, we cannot confirm repairs. Issues may affect cost and time.</li><li><strong>Deposit & Booking:</strong> A deposit is required to secure your booking. By proceeding, you accept these terms.</li><li><strong>Cancellation Policy:</strong> Cancellations after deposit may result in forfeiture. Rescheduling may affect availability.</li><li><strong>Limitations of Remote Quotes:</strong> Quotes are estimates only. Final pricing may adjust if hidden damage or access issues are found.</li><li><strong>Client Responsibility:</strong> Surfaces must be clean, dry, and accessible. Delays from unprepared sites may incur charges.</li></ol></div><div style="text-align:right;margin-top:12px"><button class="btn" id="closeDisclaimerBtn">Close</button></div></div></div>

            <div class="rq-modal" id="confirmationModal"><div class="modal-content"><h2>‚úÖ Thanks!</h2><p>Your request has been sent successfully.</p><p>We aim to respond within <strong>48 hours</strong> ‚Äî please keep an eye on WhatsApp and your email (check your spam folder too).</p><div style="text-align:right;margin-top:12px"><button class="btn" id="closeConfirmationBtn">Close</button></div></div></div>

            <!-- Client Details -->
            <div class="form-group"><label for="firstName">First Name <span class="required">*</span></label><input type="text" id="firstName" name="firstName" required></div>
            <div class="form-group"><label for="lastName">Last Name <span class="required">*</span></label><input type="text" id="lastName" name="lastName" required></div>
            <div class="form-group"><label for="phone">Phone Number <span class="required">*</span></label><input type="tel" id="phone" name="phone" required></div>
            <div class="form-group"><label for="email">Email <span class="required">*</span></label><input type="email" id="email" name="email" required></div>
            <div class="form-group"><label for="address1">Address (Street) <span class="required">*</span></label><input type="text" id="address1" name="address1" required></div>
            <div class="form-group"><label for="address2">Address Line 2</label><input type="text" id="address2" name="address2"></div>
            <div class="form-group"><label for="cityCounty">City / County <span class="required">*</span></label><input type="text" id="cityCounty" name="cityCounty" required></div>
            <div class="form-group"><label for="postcode">Post Code <span class="required">*</span></label><input type="text" id="postcode" name="postcode" required></div>

            <div class="form-group"><label for="services">What services are you interested in? <span class="required">*</span></label><select id="services" name="services" required><option value="" disabled selected>Select one</option><option value="Kitchen Worktop Wrapping">Kitchen Worktop Wrapping</option><option value="Kitchen Cupboard Wrapping">Kitchen Cupboard Wrapping</option><option value="Kitchen Worktop and Cupboard Wrap">Kitchen Worktop and Cupboard Wrap</option><option value="Commercial Wrapping">Commercial Wrapping</option><option value="Window Film Installation">Window Film Installation</option><option value="Other">Other</option></select></div>
            <div class="form-group hidden" id="otherServiceGroup"><label for="otherService">Please specify what you‚Äôd like wrapped <span class="required">*</span></label><textarea id="otherService" name="otherService"></textarea></div>

            <div class="form-group"><label>Is the surface to be wrapped damaged? <span class="required">*</span></label><select id="surfaceDamage" name="surfaceDamage" required><option value="" disabled selected>Select</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="form-group hidden" id="damageDetailsGroup"><label for="damageDetails">If ‚ÄúYes‚Äù, please explain <span class="required">*</span></label><textarea id="damageDetails" name="damageDetails"></textarea></div>

            <div class="form-group"><label for="budget">Do you have a budget in mind? <span class="required">*</span></label><input type="text" id="budget" name="budget" required></div>
            <div class="form-group"><label for="stylePattern">What style/pattern are you looking for? <span class="required">*</span></label><select id="stylePattern" name="stylePattern" required><option value="" disabled selected>Select one</option><option value="Woodgrain">Woodgrain</option><option value="Marble">Marble</option><option value="Stone">Stone</option><option value="Gloss Colour">Gloss Colour</option><option value="Matt Colour">Matt Colour</option><option value="Other">Other</option></select></div>

            <div class="form-group"><label>Images of the area / any damage <span class="required">*</span></label><p style="font-size:0.95rem; color:#555;">Please send any photos to <strong>contact@elitewrapz.uk</strong> and include your <strong>name</strong> in the subject line.</p></div>

            <div class="form-group"><label for="additionalInfo">Any more details you‚Äôd like to share <span class="required">*</span></label><textarea id="additionalInfo" name="additionalInfo" required></textarea></div>

            <div class="form-group hidden"><label>Should be empty: <input type="text" name="honeypot"></label></div>

            <div style="text-align:center;margin-top:14px"><button type="submit" class="btn-submit">Submit</button></div>
          </form>
        </div>
      `;

      container.innerHTML = markup;
      appView.appendChild(container);

      // Now inject and run the page script (adapted exactly from the provided file)
      const scriptCode = `
        const reasonEl = document.getElementById("reason");
        const disclaimerGroup = document.getElementById("disclaimerGroup");
        const ackDisclaimer = document.getElementById("ackDisclaimer");
        const disclaimerModal = document.getElementById("disclaimerModal");
        const viewDisclaimerBtn = document.getElementById("viewDisclaimerBtn");
        const closeDisclaimerBtn = document.getElementById("closeDisclaimerBtn");
        const confirmationModal = document.getElementById("confirmationModal");
        const closeConfirmationBtn = document.getElementById("closeConfirmationBtn");

        reasonEl.addEventListener("change", () => {
          if (reasonEl.value === "Out of Area" || reasonEl.value === "No Face to Face") {
            disclaimerGroup.classList.remove("hidden");
            ackDisclaimer.required = true;
          } else {
            disclaimerGroup.classList.add("hidden");
            ackDisclaimer.required = false;
            ackDisclaimer.checked = false;
          }
        });

        viewDisclaimerBtn.addEventListener("click", () => {
          disclaimerModal.style.display = "flex";
        });
        // closeDisclaimerBtn might not exist in this injected markup; guard it
        if(closeDisclaimerBtn) closeDisclaimerBtn.addEventListener("click", () => {
          disclaimerModal.style.display = "none";
        });

        if(closeConfirmationBtn) closeConfirmationBtn.addEventListener("click", () => {
          confirmationModal.style.display = "none";
        });

        document.getElementById("remoteQuoteForm").addEventListener("submit", function(e) {
          if ((reasonEl.value === "Out of Area" || reasonEl.value === "No Face to Face") && !ackDisclaimer.checked) {
            e.preventDefault();
            alert("Please accept the terms before submitting.");
            return;
          }
          e.preventDefault();
          const form = this;
          const formData = new FormData(form);

          fetch("https://script.google.com/macros/s/AKfycbzOzEEaxtDfc7g5MUm1sIIilwWX8HB_dE2lKZZWp6tyKEuTz6_drnFSgU4QUGnsZNtO_Q/exec", {
            method: "POST",
            body: formData
          })
          .then(() => {
            // open the confirmation modal if available, else toast
            if(confirmationModal) confirmationModal.style.display = 'flex';
            form.reset();
            disclaimerGroup.classList.add("hidden");
          })
          .catch(() => alert("‚ùå Sorry, there was an error. Please try again."));
        });
      `;

      const scriptEl = document.createElement('script');
      scriptEl.type = 'text/javascript';
      scriptEl.text = scriptCode;
      document.body.appendChild(scriptEl);

      return container;
    }
    
    /* Referrals View - inline implementation (create, check, use, list) */
    function renderReferrals(){
      const view = document.getElementById('view');
      view.innerHTML = '';

      const container = el('div',{class:'card pad'},[]);
      container.append(el('div',{class:'section-title',html:'Referrals'}));

      const grid = el('div',{class:'row'},[]);

      // Left column: create / use forms
      const left = el('div',{style:'flex:1;min-width:320px;max-width:520px;'},[]);

      const createCard = el('div',{class:'card pad'},[]);
      createCard.append(el('div',{class:'section-title',html:'Create referral code'}));
      createCard.append(el('div',{html:`
        <label>Referrer name:<input class="input" id="ref_clientName" placeholder="Client name (referrer)"></label>
        <label>Job reference:<input class="input" id="ref_jobRef" placeholder="Job reference"></label>
        <label>Job total:<input class="input" id="ref_jobTotal" type="number" step="0.01" placeholder="Job total"></label>
        <div style="margin-top:10px"><button class="btn primary" id="createRefBtn">Create Code</button></div>
        <pre id="createResult" class="hint" style="margin-top:8px"></pre>
      `}));

      const useCard = el('div',{class:'card pad'},[]);
      useCard.append(el('div',{class:'section-title',html:'Use referral code'}));
      useCard.append(el('div',{html:`
        <label>Referral code:<input class="input" id="use_code" placeholder="Referral code"></label>
        <label>New client name:<input class="input" id="use_newClient" placeholder="New client name"></label>
        <div style="margin-top:10px"><button class="btn" id="useRefBtn">Apply Code</button></div>
        <pre id="useResult" class="hint" style="margin-top:8px"></pre>
      `}));

      left.append(createCard, el('div',{style:'height:12px'}), useCard);

      // Right column: list of referrals
      const right = el('div',{style:'flex:2;min-width:360px'},[]);
      const listCard = el('div',{class:'card pad'},[]);
      listCard.append(el('div',{class:'section-title',html:'All referrals'}));
      const tableWrap = el('div',{},[]);
      tableWrap.innerHTML = `
        <table class="table" id="ref_table">
          <thead><tr><th>Client</th><th>Code</th><th>Job Ref</th><th>Job Total</th><th>Used</th><th>Used By</th><th>Date Used</th></tr></thead>
          <tbody id="ref_list"></tbody>
        </table>
      `;
      listCard.append(tableWrap);
      right.append(listCard);

      grid.append(left, right);
      container.append(grid);
      view.appendChild(container);

      // simple API helper (fallback)
      async function apiFetch(path, opts={}){
        const headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
        const res = await fetch(path, Object.assign({}, opts, { headers }));
        const text = await res.text();
        let data = null;
        try{ data = text ? JSON.parse(text) : null; }catch(e){ data = text; }
        if(!res.ok) throw new Error(data && data.error ? data.error : (res.statusText || 'Request failed'));
        return data;
      }

      function showError(el, err){
        const txt = (err && err.message) ? err.message : String(err);
        el.textContent = txt;
        showToast(txt);
      }

      async function loadList(){
        const tbody = document.getElementById('ref_list');
        tbody.innerHTML = '';
        try{
          let list = [];
          if(window.FirebaseHelpers && typeof window.FirebaseHelpers.listReferrals === 'function'){
            list = await window.FirebaseHelpers.listReferrals();
          } else {
            list = await apiFetch('/api/referrals');
          }
          list.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${(r.clientName||'')}</td>
              <td style="font-weight:700;color:var(--brand)">${r.referralCode}</td>
              <td>${(r.jobRef||'')}</td>
              <td>${currency(r.jobTotal||0)}</td>
              <td>${r.used? 'Yes' : 'No'}</td>
              <td>${r.usedBy || ''}</td>
              <td>${r.usedDate ? (r.usedDate.seconds ? new Date(r.usedDate.seconds*1000).toLocaleString() : new Date(r.usedDate).toLocaleString()) : ''}</td>
            `;
            tbody.appendChild(tr);
          });
        }catch(e){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="7" class="empty">Failed to load referrals</td>`;
          tbody.appendChild(tr);
        }
      }

      // Wire actions
      document.getElementById('createRefBtn').addEventListener('click', async (ev)=>{
        ev.preventDefault();
        const resPre = document.getElementById('createResult'); resPre.textContent = 'Creating...';
        const clientName = document.getElementById('ref_clientName').value.trim();
        const jobRef = document.getElementById('ref_jobRef').value.trim();
        const jobTotal = parseFloat(document.getElementById('ref_jobTotal').value || 0);
        if(!clientName || !jobRef){ showError(resPre, new Error('Referrer name and job ref required')); return; }
        try{
          let rec;
          if(window.FirebaseHelpers && typeof window.FirebaseHelpers.createReferral === 'function'){
            rec = await window.FirebaseHelpers.createReferral({ clientName, jobRef, jobTotal });
          } else {
            rec = await apiFetch('/api/referrals/create', { method: 'POST', body: JSON.stringify({ clientName, jobRef, jobTotal }) });
          }
          resPre.textContent = JSON.stringify(rec, null, 2);
          showToast('Referral created');
          loadList();
        }catch(e){ showError(resPre, e); }
      });

      document.getElementById('useRefBtn').addEventListener('click', async (ev)=>{
        ev.preventDefault();
        const resPre = document.getElementById('useResult'); resPre.textContent = 'Applying...';
        const code = document.getElementById('use_code').value.trim().toUpperCase();
        const newClient = document.getElementById('use_newClient').value.trim();
        if(!code || !newClient){ showError(resPre, new Error('Code and new client name required')); return; }
        try{
          let out;
          if(window.FirebaseHelpers && typeof window.FirebaseHelpers.useReferralCode === 'function'){
            out = await window.FirebaseHelpers.useReferralCode(code, newClient);
          } else {
            out = await apiFetch('/api/referrals/use', { method: 'POST', body: JSON.stringify({ code, newClientName: newClient }) });
          }
          resPre.textContent = JSON.stringify(out, null, 2);
          showToast('Code applied');
          loadList();
        }catch(e){ showError(resPre, e); }
      });

      // initial load
      loadList();

      return container;
    }
    // --- EMAIL VIEW ---

    function renderEmail() {
      const view = document.getElementById('view');
      view.innerHTML = '';
      const container = document.createElement('div');
      container.className = 'card pad';
      container.innerHTML = `
        <h2 style="margin-top:0">Compose Email</h2>
        <div class="row" style="gap:18px;align-items:flex-start;flex-wrap:wrap">
          <div style="flex:2;min-width:320px">
            <label>To:<input class="input" id="emailTo" type="email" placeholder="recipient@email.com" required></label><br>
            <label>Subject:<input class="input" id="emailSubject" type="text" placeholder="Subject"></label><br>
            <!-- Templates removed -->
            <label>Body:<textarea class="input" id="emailBody" rows="8" placeholder="Write your email..."></textarea></label><br>
            <!-- Attachments removed -->
            <button class="btn primary" id="sendEmailBtn">Send Email</button>
          </div>
        </div>
        </div>
        <div class="hint" style="margin-top:10px">Emails are sent via Google Apps Script.</div>
      `;
      view.appendChild(container);

      const subjectEl = document.getElementById('emailSubject');
      const bodyEl = document.getElementById('emailBody');

      // Send email (calls Google Apps Script endpoint)
      document.getElementById('sendEmailBtn').addEventListener('click', async () => {
        const to = document.getElementById('emailTo').value;
        const subject = subjectEl.value;
        const body = bodyEl.value;
  // attachments removed: no files collected
        if(!to){ showToast('Recipient required'); return; }
        const formData = new FormData();
        formData.append('to', to);
        formData.append('subject', subject);
        formData.append('body', body);
        // Attachments are not supported in this build.
        // TODO: Replace with your deployed Google Apps Script web app URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzX0fCROXoQqcaqTYJowzG0nHnLpnuuX3eGa8J-VsJ_zupupPs1ENlbBPTvf6WltgUMIw/exec';
        try {
          const res = await fetch(APPS_SCRIPT_URL, { method:'POST', body:formData });
          if(res.ok) showToast('Email sent!');
          else showToast('Send failed');
        } catch(e){ showToast('Send error'); }
      });
    }

    // Templates view ‚Äî inlined from provided templates page
    function renderTemplates(){
      const view = document.getElementById('view'); view.innerHTML = '';
      const container = el('div',{class:'card pad'});
      container.append(el('h2',{html:'Templates'}));

      const markup = `
        <div style="max-width:1100px;margin:0 auto">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            <div>
              <label>Client Name</label>
              <input id="tpl_clientName" class="input" placeholder="Enter client first name">
              <label style="margin-top:12px">Client Email</label>
              <input id="tpl_clientEmail" class="input" placeholder="Enter client email">
              <label style="margin-top:12px">Select Template</label>
              <select id="tpl_templateSelect" class="input"></select>

              <div id="tpl_depositFields" class="extraFields" style="display:none;margin-top:12px">
                <h4>Deposit Request Details</h4>
                <label>Quote Total (¬£)</label><input id="tpl_quoteTotal_deposit" class="input" type="number">
                <label>Deposit Total (¬£)</label><input id="tpl_depositTotal_deposit" class="input" type="number">
                <label>Payment Link</label><input id="tpl_paymentLink_deposit" class="input" type="url" placeholder="https://‚Ä¶">
              </div>

              <div id="tpl_quoteSentFields" class="extraFields" style="display:none;margin-top:12px">
                <h4>Quote Sent Details</h4>
                <label>Quote Total (¬£)</label><input id="tpl_quoteTotal_quote" class="input" type="number">
                <label>Deposit Total (¬£)</label><input id="tpl_depositTotal_quote" class="input" type="number">
              </div>

              <div id="tpl_bookingFields" class="extraFields" style="display:none;margin-top:12px">
                <h4>Booking Details</h4>
                <label>Booking Date</label><input id="tpl_bookingDate" class="input">
                <label>Booking Time</label><input id="tpl_bookingTime" class="input">
              </div>

              <div id="tpl_signatureFields" class="extraFields" style="display:none;margin-top:12px">
                <h4>Signature Request Details</h4>
                <label>Signature Link</label><input id="tpl_signatureLink" class="input" placeholder="Paste signature link">
                <label>Agreement Type</label>
                <select id="tpl_agreementType" class="input"><option>Services Agreement</option><option>14 Day Cooling-Off Waiver</option><option>Payment Plan Agreement</option></select>
              </div>
            </div>

            <div>
              <label>Subject Preview</label>
              <input id="tpl_subjectPreview" class="input" readonly>
              <label style="margin-top:12px">Generated Message</label>
              <textarea id="tpl_messageBox" class="input" rows="16" readonly></textarea>
              <div style="display:flex;gap:8px;margin-top:12px">
                <button class="btn btn-secondary" id="tpl_copyBtn">üìã Copy</button>
                <button class="btn btn-primary" id="tpl_emailBtn">‚úâÔ∏è Open in Email App</button>
              </div>
            </div>
          </div>
        </div>
      `;

      container.innerHTML += markup; view.appendChild(container);

      // Templates data (reuse the global templates object)
      const sel = document.getElementById('tpl_templateSelect');
      const msgBox = document.getElementById('tpl_messageBox');
      const subj = document.getElementById('tpl_subjectPreview');

      function populateList(){ sel.innerHTML = '<option value="">-- Choose a template --</option>'; const order = ["Quote Sent","Quote Reminder","Deposit Request","Services Agreement","Signature Request","Booking Confirmation","Wrap Day Prep","Thank You & Reviews"]; order.forEach(name=>{ if(templates[name]){ const o = document.createElement('option'); o.value = name; o.textContent = name; sel.appendChild(o); } }); }
      populateList();

      function update(){ const name = document.getElementById('tpl_clientName').value || 'Customer'; const selected = sel.value; if(selected && templates[selected]){ let msg = templates[selected].body.replace('{name}', name); let subject = templates[selected].subject; if(selected === 'Deposit Request'){ let q = document.getElementById('tpl_quoteTotal_deposit').value; let d = document.getElementById('tpl_depositTotal_deposit').value; const l = document.getElementById('tpl_paymentLink_deposit').value || '[Insert Link]'; const quote = q ? `¬£${q}` : '____'; const deposit = d ? `¬£${d}` : '____'; msg = msg.replace('{quoteTotal}', quote).replace('{depositTotal}', deposit).replace('{paymentLink}', l); }
        if(selected === 'Quote Sent'){ let q = document.getElementById('tpl_quoteTotal_quote').value; let d = document.getElementById('tpl_depositTotal_quote').value; const quote = q ? `¬£${q}` : '____'; const deposit = d ? `¬£${d}` : '____'; msg = msg.replace('{quoteTotal}', quote).replace('{depositTotal}', deposit); }
        if(selected === 'Booking Confirmation'){ const date = document.getElementById('tpl_bookingDate').value || '____'; const time = document.getElementById('tpl_bookingTime').value || '____'; msg = msg.replace('{bookingDate}', date).replace('{bookingTime}', time); }
        if(selected === 'Signature Request'){ const link = document.getElementById('tpl_signatureLink').value || '[Insert Link]'; const agreement = document.getElementById('tpl_agreementType').value || 'Agreement'; msg = msg.replace('{signatureLink}', link).replace(/{agreementType}/g, agreement); subject = subject.replace('{agreementType}', agreement); }
        msgBox.value = msg; msgBox.dataset.subject = subject; subj.value = subject; } else { msgBox.value = ''; subj.value = ''; }
      }

      sel.addEventListener('change', ()=>{ document.querySelectorAll('#tpl_depositFields,#tpl_quoteSentFields,#tpl_bookingFields,#tpl_signatureFields').forEach(d=>d.style.display='none'); if(sel.value==='Deposit Request') document.getElementById('tpl_depositFields').style.display='block'; if(sel.value==='Quote Sent') document.getElementById('tpl_quoteSentFields').style.display='block'; if(sel.value==='Booking Confirmation') document.getElementById('tpl_bookingFields').style.display='block'; if(sel.value==='Signature Request') document.getElementById('tpl_signatureFields').style.display='block'; update(); });

      document.querySelectorAll('#tpl_clientName, #tpl_clientEmail, #tpl_quoteTotal_deposit, #tpl_depositTotal_deposit, #tpl_paymentLink_deposit, #tpl_quoteTotal_quote, #tpl_depositTotal_quote, #tpl_bookingDate, #tpl_bookingTime, #tpl_signatureLink, #tpl_agreementType').forEach(inp=>{ if(inp) inp.addEventListener('input', update); });

      document.getElementById('tpl_copyBtn').addEventListener('click', ()=>{ if(!msgBox.value) return showToast('No message to copy!', 'error'); navigator.clipboard.writeText(msgBox.value).then(()=>showToast('Message copied to clipboard!')).catch(()=>showToast('Unable to access clipboard.', 'error')); });
      document.getElementById('tpl_emailBtn').addEventListener('click', ()=>{ const email = document.getElementById('tpl_clientEmail').value; const selected = sel.value; if(!selected || !templates[selected]) return showToast('Please select a template first.', 'error'); const subject = msgBox.dataset.subject || templates[selected].subject; const body = encodeURIComponent(msgBox.value); if(email && body){ window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${body}`; } else { showToast('Please enter the client‚Äôs email and select a template.', 'error'); } });

      return container;
    }

    /* Settings view */
    const SETTINGS_KEY = 'ew_settings';
    function loadSettings(){ return Store.get(SETTINGS_KEY, { tags: [], logoDataUrl: null, other: {} }); }
    function saveSettings(s){ Store.set(SETTINGS_KEY, s); }

    /* Data export/import helpers */
    function exportAll(){
      try{
        const data = {};
        for(let i=0;i<localStorage.length;i++){ const k = localStorage.key(i); data[k]=localStorage.getItem(k); }
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'elite-hq-backup-'+(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showToast('Exported data');
      }catch(e){ showToast('Export failed'); }
    }

    function importAllFromFile(file){
      if(!file) return showToast('No file selected');
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const parsed = JSON.parse(reader.result);
          // merge into localStorage (overwrite existing keys)
          Object.keys(parsed).forEach(k=>{ try{ localStorage.setItem(k, parsed[k]); }catch(e){} });
          showToast('Import complete ‚Äî refreshing view');
          // rehydrate app state
          setTimeout(()=> location.reload(), 750);
        }catch(e){ showToast('Invalid JSON file'); }
      };
      reader.readAsText(file);
    }

    // Attach import file handler (if importFile element exists later when settings rendered)
    document.addEventListener('change', (e)=>{
      if(e.target && e.target.id === 'importFile'){
        const f = e.target.files && e.target.files[0]; if(f) importAllFromFile(f);
      }
    });

    /* Autosave signalling (visual indicator) */
    function setAutosaveState(text){ const el = document.getElementById('autosaveState'); if(!el) return; el.textContent = text; }
    // Monkey-patch Store.set to signal autosave (non-destructive)
    if(window.Store && typeof Store.set === 'function'){
      const _origSet = Store.set.bind(Store);
      Store.set = function(k,v){ _origSet(k,v); try{ setAutosaveState('Saved'); setTimeout(()=> setAutosaveState('‚Äî'), 1200); }catch(e){} };
    }

    function renderSettings(){
      const view = document.getElementById('view'); view.innerHTML = '';
      const cfg = loadSettings();
      // normalize tags to objects {name,color} for newer UX
      cfg.tags = (cfg.tags||[]).map(t => (typeof t === 'string') ? { name: t, color: '#01FABF' } : (t.name? t : { name: String(t), color: '#01FABF' }));
      const wrap = el('div',{},[
        el('div',{class:'card pad'},[
          el('div',{class:'section-title',html:'Branding & Logo'}),
          el('div',{style:'display:flex;gap:12px;align-items:center'},[
            el('div',{class:'top-logo',style:'width:64px;height:64px;border-radius:12px;overflow:hidden'},[ el('span',{},[document.createTextNode('EW')]), el('img',{id:'settingsLogoImg', src: cfg.logoDataUrl || '', alt:''}) ]),
            el('div',{},[ el('div',{html:'Upload a brand logo (.png/.jpg/.svg)'}), el('div',{style:'height:8px'}), el('input',{type:'file',id:'logoFile',accept:'.png,.jpg,.jpeg,.svg'}) ])
          ])
        ]),
        el('div',{style:'height:12px'}),
        el('div',{class:'card pad'},[
          el('div',{class:'section-title',html:'Tags & Metadata'}),
          el('div',{style:'display:flex;gap:8px;align-items:center;margin-bottom:8px'},[
              el('input',{id:'newTag',class:'input',placeholder:'Add tag and press Enter'}), el('input',{type:'color',id:'newTagColor',value:'#01FABF',style:'width:44px;height:36px;padding:4px;border-radius:8px;border:1px solid var(--line)'}), el('button',{class:'chip',onclick:addTag},[document.createTextNode('Add')]), el('button',{class:'chip',onclick:openTagManager,style:'margin-left:8px'},[document.createTextNode('Manage tags')])
            ]),
            el('div',{id:'tagsWrap',style:'display:flex;gap:8px;flex-wrap:wrap'}),
          el('div',{style:'height:8px'}),
          el('div',{class:'hint',html:'Tags help you categorize contacts, projects and suppliers.'})
        ])
        ,
        el('div',{style:'height:12px'}),
        el('div',{class:'card pad'},[
          el('div',{class:'section-title',html:'Data ‚Äî Export / Import'}),
          el('div',{style:'display:flex;gap:8px;align-items:center;margin-bottom:8px'},[
            el('button',{class:'chip',onclick:exportAll},[document.createTextNode('Export data')]),
            el('label',{class:'chip',style:'cursor:pointer'},[ el('input',{type:'file',id:'importFile',accept:'.json',style:'display:none'}), document.createTextNode('Import data') ])
          ]),
          el('div',{class:'hint',html:'Export a JSON backup of your entire app data. Import will merge keys into localStorage (existing keys are overwritten).'}),
        ])
      ,
      el('div',{style:'height:12px'}),
      el('div',{class:'card pad'},[
        el('div',{class:'section-title',html:'Theme & Presets'}),
        el('div',{style:'display:grid;grid-template-columns:1fr 240px;gap:12px;align-items:start'},[
          el('div',{},[
            // stacked color pickers to avoid overlapping the Saved Presets column
            el('div',{style:'display:flex;flex-direction:column;gap:8px;align-items:start;margin-bottom:8px'},[
              el('div',{style:'display:flex;align-items:center;gap:8px'},[ el('label',{style:'width:120px'},[document.createTextNode('Primary Color')]), el('input',{type:'color',id:'themePrimary',value:'#01FABF'}) ]),
              el('div',{style:'display:flex;align-items:center;gap:8px'},[ el('label',{style:'width:120px'},[document.createTextNode('Background')]), el('input',{type:'color',id:'themeBg',value:'#f6f8fb'}) ]),
              el('div',{style:'display:flex;align-items:center;gap:8px'},[ el('label',{style:'width:120px'},[document.createTextNode('Surface')]), el('input',{type:'color',id:'themeSurface',value:'#ffffff'}) ]),
              el('div',{style:'display:flex;align-items:center;gap:8px'},[ el('label',{style:'width:120px'},[document.createTextNode('Ink')]), el('input',{type:'color',id:'themeInk',value:'#0f172a'}) ])
            ]),
            el('div',{style:'display:flex;gap:8px;align-items:center;flex-wrap:wrap'},[
              el('label',{style:'width:120px'},[document.createTextNode('Radius px')]), el('input',{type:'number',id:'themeRadius',value:14,style:'width:80px'}),
              // shrink shadow select to avoid overflow and allow wrapping
              el('label',{style:'width:120px;margin-left:12px'},[document.createTextNode('Shadow')]), el('select',{id:'themeShadow',style:'min-width:120px;max-width:160px'},[ el('option',{value:'sm',html:'Small'}), el('option',{value:'md',html:'Medium'}) ])
            ]),
            el('div',{style:'height:8px'}),
            el('div',{class:'row',style:'justify-content:flex-start;gap:8px;flex-wrap:wrap'},[
              el('button',{class:'chip',onclick:applyThemeFromInputs},[document.createTextNode('Apply')])
            ])
          ]),
          // Saved Presets column removed to simplify layout
        ])
      ])
      ,
      // Email templates removed from Settings
      ]);
      view.append(wrap);

      

      const logoFile = document.getElementById('logoFile');
      const settingsLogoImg = document.getElementById('settingsLogoImg');
  function showLogo(dataUrl){ settingsLogoImg.style.display = dataUrl ? 'block' : 'none'; settingsLogoImg.src = dataUrl || ''; }
      showLogo(cfg.logoDataUrl);
      logoFile.addEventListener('change', async (e)=>{
        const f = e.target.files && e.target.files[0]; if(!f) return;
        const reader = new FileReader(); reader.onload = ()=>{
          cfg.logoDataUrl = reader.result; saveSettings(cfg); showLogo(cfg.logoDataUrl);
          // persist shared logo key so other UI elements update
          try{ localStorage.setItem(LOGO_KEY, cfg.logoDataUrl); } catch(e){}
          applyLogos();
        }; reader.readAsDataURL(f);
      });

  // tags (now objects with name + color)
  function renderTags(){ const wrap = document.getElementById('tagsWrap'); wrap.innerHTML=''; (cfg.tags||[]).forEach((t,i)=>{ const pill = el('div',{class:'chip',style:`display:inline-flex;align-items:center;gap:8px;background:${t.color}22;border-color:${t.color}`},[ el('span',{style:`width:12px;height:12px;border-radius:4px;background:${t.color};display:inline-block;margin-right:6px`}), document.createTextNode(t.name), el('button',{class:'chip',onclick:()=>{ cfg.tags.splice(i,1); saveSettings(cfg); renderTags(); }},[document.createTextNode('x')]) ]); wrap.append(pill); }); }
  function addTag(){ const v = (document.getElementById('newTag').value||'').trim(); const color = (document.getElementById('newTagColor')||{}).value||'#01FABF'; if(!v) return; if(!(cfg.tags||[]).some(x=>x.name.toLowerCase()===v.toLowerCase())){ (cfg.tags = cfg.tags||[]).push({name:v, color}); saveSettings(cfg); renderTags(); document.getElementById('newTag').value=''; } }
  document.getElementById('newTag').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addTag(); } });
  renderTags();

      // Tag Manager modal ‚Äî bulk operations
      function openTagManager(){
        const modalBody = el('div',{},[]);
        const list = el('div',{},[]);
        function refreshList(){ list.innerHTML=''; (cfg.tags||[]).forEach((t,i)=>{
          const row = el('div',{style:'display:flex;gap:8px;align-items:center;margin-bottom:8px'},[
            el('input',{value:t.name,class:'input',style:'flex:1'}),
            el('input',{type:'color',value:t.color,style:'width:44px;height:36px;padding:4px;border-radius:8px;border:1px solid var(--line)'}),
            el('div',{},[
              el('button',{class:'chip',onclick:()=>{ if(i>0){ const tmp = cfg.tags[i-1]; cfg.tags[i-1]=cfg.tags[i]; cfg.tags[i]=tmp; saveSettings(cfg); refreshList(); renderTags(); } }},[document.createTextNode('‚Üë')]),
              el('button',{class:'chip',onclick:()=>{ if(i<cfg.tags.length-1){ const tmp = cfg.tags[i+1]; cfg.tags[i+1]=cfg.tags[i]; cfg.tags[i]=tmp; saveSettings(cfg); refreshList(); renderTags(); } }},[document.createTextNode('‚Üì')]),
            ]),
            el('button',{class:'chip',onclick:()=>{ cfg.tags.splice(i,1); saveSettings(cfg); refreshList(); renderTags(); }},[document.createTextNode('Delete')])
          ]);
          // wire inline edits
          row.querySelectorAll('input')[0].addEventListener('input', (e)=>{ cfg.tags[i].name = e.target.value; saveSettings(cfg); renderTags(); });
          row.querySelectorAll('input')[1].addEventListener('input', (e)=>{ cfg.tags[i].color = e.target.value; saveSettings(cfg); renderTags(); });
          list.append(row);
        }); }
        refreshList();
        modalBody.append(list, el('div',{style:'height:8px'}), el('div',{class:'row',style:'justify-content:flex-end;gap:8px'},[
          el('button',{class:'chip',onclick:()=>{ // reorder: simple alphabetic
            cfg.tags.sort((a,b)=>a.name.localeCompare(b.name)); saveSettings(cfg); refreshList(); renderTags();
          }},[document.createTextNode('Sort A‚ÄìZ')]),
          el('button',{class:'chip',onclick:()=>{ // merge duplicates
            const map = {}; cfg.tags.forEach(t=>{ map[t.name.toLowerCase()] = map[t.name.toLowerCase()] || t; }); cfg.tags = Object.values(map); saveSettings(cfg); refreshList(); renderTags(); }},[document.createTextNode('Merge duplicates')])
        ]));
        openModal('Tag Manager', modalBody, ()=>{ return true; }, 'Close');
      }
        // Theme helpers
        function getThemeInputs(){ return {
          primary: (document.getElementById('themePrimary')||{}).value || '#01FABF',
          bg: (document.getElementById('themeBg')||{}).value || '#f6f8fb',
          surface: (document.getElementById('themeSurface')||{}).value || '#ffffff',
          ink: (document.getElementById('themeInk')||{}).value || '#0f172a',
          radius: Number((document.getElementById('themeRadius')||{}).value) || 14,
          shadow: (document.getElementById('themeShadow')||{}).value || 'sm'
        }; }
        function applyTheme(theme){
          try{
            document.documentElement.style.setProperty('--brand', theme.primary || '#01FABF');
            document.documentElement.style.setProperty('--bg', theme.bg || '#f6f8fb');
            document.documentElement.style.setProperty('--surface', (theme.surface||'#ffffff'));
            document.documentElement.style.setProperty('--ink', theme.ink || '#0f172a');
            document.documentElement.style.setProperty('--radius', (theme.radius||14)+'px');
            if(theme.shadow === 'md') document.documentElement.style.setProperty('--shadow-sm','0 10px 30px rgba(2,6,23,.08)');
            else document.documentElement.style.setProperty('--shadow-sm','0 4px 14px rgba(2,6,23,.06)');
            if(typeof showToast === 'function') showToast('Theme applied', {type:'success'});
          }catch(e){ showToast('Apply theme failed'); }
        }
        function applyThemeFromInputs(){ applyTheme(getThemeInputs()); }
  // preset save removed
    // presets feature removed
    }
    function route(){
      const hash = location.hash.replace('#/','') || 'dashboard';
      $$('#nav a').forEach(a=>a.classList.toggle('active', a.dataset.route===hash));
      $('#crumb').textContent = hash[0].toUpperCase()+hash.slice(1);
      routes[hash]();
      hydrateInlineIcons();
      // Auto-open signatures group if a sub-route is selected
      const sigGroup = document.querySelector('.nav-group[data-group="signatures"]');
      if(sigGroup){
        const isSig = (hash==='signatures' || hash==='remote-sign');
        if(isSig) sigGroup.classList.add('open');
      }
      // Auto-open quotes group if one of its routes is selected
      const quotesGroup = document.querySelector('.nav-group[data-group="quotes"]');
      if(quotesGroup){
        const isQuote = (hash==='quote' || hash==='remote-quote');
        if(isQuote) quotesGroup.classList.add('open');
      }
    }

    // Always show dashboard as default page
    if (!location.hash || location.hash === '#' || location.hash === '#/') {
      location.hash = '#/dashboard';
    }
    window.addEventListener('hashchange', route);

    /************ Views ************/
    function renderDashboard(){
      const active = db.projects.filter(p=>p.status!=='Completed').length;
      const totalVal = db.projects.reduce((a,b)=>a+(+b.budget||0),0);

      $('#view').innerHTML = '';
      const wrap = el('div',{},[
        el('div',{class:'welcome'},[
          el('h2',{html:'Welcome to Elite HQ'}),
          el('p',{html:'Your interior vinyl wrapping business command center'})
        ]),
        el('div',{style:'height:12px'}),
        el('div',{class:'stats'},[
          stat('b-blue','user','Total Contacts', db.contacts.length),
          stat('b-green','wrench','Active Projects', active),
          stat('b-purple','folder','Total Projects', db.projects.length),
          stat('b-yellow','credit','Project Value', currency(totalVal))
        ]),
        el('div',{style:'height:12px'}),
        card('Quick Links', renderQuickLinksSection()),
        el('div',{style:'height:12px'}),
        card('Recent Contacts', renderRecentContacts()),
        card('Recent Projects', renderRecentProjects()),
      ]);
      $('#view').append(wrap);
    }
    function stat(badgeClass, iconKey, label, value){
      const badge = el('div',{class:'badge '+badgeClass, html: renderIcon(iconKey)});
      return el('div',{class:'stat'},[
        badge,
        el('div',{},[ el('div',{class:'val',html:value}), el('div',{class:'muted',html:label}) ])
      ]);
    }
    function card(title, content){
      const box = el('div',{class:'card pad', style:'margin-bottom:12px'},[]);
      box.append(el('div',{class:'section-title',html:title}));
      box.append(content);
      return box;
    }

    /* Quick links */
    function renderQuickLinksSection(){
      const box = el('div',{});
      const grid = el('div',{class:'links-grid'});
      db.links.forEach(link=>grid.append(quickLinkCard(link)));
      // enable drag within quick links grid for reordering
      grid.addEventListener('dragstart', (e)=>{
        const a = e.target.closest('.ql-card'); if(!a) return;
        e.dataTransfer.setData('text/plain', a.dataset.id || '');
        a.classList.add('dragging');
      });
      grid.addEventListener('dragend', (e)=>{ const a = e.target.closest('.ql-card'); if(a) a.classList.remove('dragging'); });
      grid.addEventListener('dragover', (e)=>{ e.preventDefault(); const over = e.target.closest('.ql-card'); $$('.ql-card',grid).forEach(x=>x.classList.remove('drag-over')); if(over) over.classList.add('drag-over'); });
      grid.addEventListener('dragleave', (e)=>{ const over = e.target.closest('.ql-card'); if(over) over.classList.remove('drag-over'); });
      grid.addEventListener('drop', (e)=>{
        e.preventDefault(); const draggedId = e.dataTransfer.getData('text/plain'); if(!draggedId) return;
        const over = e.target.closest('.ql-card'); if(!over) return;
        const targetId = over.dataset.id;
        const fromIdx = db.links.findIndex(x=>x.id===draggedId);
        const toIdx = db.links.findIndex(x=>x.id===targetId);
        if(fromIdx<0||toIdx<0||fromIdx===toIdx) return;
        const [item] = db.links.splice(fromIdx,1);
        db.links.splice(toIdx,0,item);
        persist(); renderQuickLinksSectionRefresh(grid);
        renderNav(); hydrateInlineIcons();
      });
      const tools = el('div',{class:'toolbar', style:'margin-top:10px'},[
        el('button',{class:'chip', onclick:()=>openLinkModal()},[document.createTextNode('+ Add Link')])
      ]);
      box.append(grid, tools);
      return box;
    }

    function renderQuickLinksSectionRefresh(grid){
      grid.innerHTML=''; db.links.forEach(link=> grid.append(quickLinkCard(link)));
    }
    function quickLinkCard(link){
      const color = link.color || 'neutral';
      const card = el('a',{href:link.url,target:'_blank',class:'ql-card','data-color':color,'data-id':link.id, draggable:'true', onclick:(e)=>{
        if(e.target.closest('.ql-actions')){ e.preventDefault(); }
      }},[
        el('div',{class:'ql-actions'},[
          el('button',{class:'chip',title:'Edit link',onclick:(e)=>{ e.stopPropagation(); e.preventDefault(); openLinkModal(link); }},[document.createTextNode('Edit')]),
          el('button',{class:'chip',title:'Delete link',onclick:(e)=>{ e.stopPropagation(); e.preventDefault(); deleteLink(link.id); }},[document.createTextNode('Delete')])
        ]),
        el('div',{class:'icon-badge', html: renderIcon(link.icon || 'link')}),
        el('div',{class:'ql-title',html:link.title}),
        el('div',{class:'ql-ext'},[document.createTextNode('‚Üó')])
      ]);
      return card;
    }
    function deleteLink(id){
      if(!confirm('Remove this quick link?')) return;
      db.links = db.links.filter(l=>l.id!==id); persist(); route();
    }

    /* Recent lists */
    function renderRecentContacts(){
      if(!db.contacts.length) return el('div',{class:'card pad'},[el('div',{class:'empty',html:'No contacts yet'})]);
      const ul = el('ul',{style:'list-style:none;margin:0;padding:0;display:grid;gap:8px'});
      db.contacts.slice(-5).reverse().forEach(c=>{
        ul.append(el('li',{class:'card pad'},[el('div',{html:`<strong>${c.name}</strong> ‚Ä¢ <span class="muted">${c.type||'Other'}</span><br><span class="muted">${c.company||''}</span>`})]));
      });
      return ul;
    }
    function renderRecentProjects(){
      if(!db.projects.length) return el('div',{class:'card pad'},[el('div',{class:'empty',html:'No projects yet'})]);
      const ul = el('ul',{style:'list-style:none;margin:0;padding:0;display:grid;gap:8px'});
      db.projects.slice(-5).reverse().forEach(p=>{
        ul.append(el('li',{class:'card pad'},[el('div',{html:`<strong>${p.name}</strong> ‚Ä¢ <span class="muted">${p.status||'Planning'}</span> ‚Ä¢ ${currency(p.budget||0)}`})]));
      });
      return ul;
    }

    /* CONTACTS ‚Äî card layout + alpha sort + details modal */
    function renderContacts(){
      const wrap = el('div',{});

      const privateCount = db.contacts.filter(c=>c.type==='Private Client').length;
      const commercialCount = db.contacts.filter(c=>c.type==='Commercial Client').length;

      wrap.append(el('div',{class:'stats'},[
        stat('b-blue','phone','Total Contacts', db.contacts.length),
        stat('b-green','user','Private Clients', privateCount),
        stat('b-purple','user','Commercial Clients', commercialCount),
        stat('b-yellow','shield','Suppliers', db.contacts.filter(c=>c.type==='Supplier').length),
      ]));
      wrap.append(el('div',{style:'height:12px'}));

      const cardWrap = el('div',{class:'card pad'});
      cardWrap.append(el('div',{class:'section-title',html:'Contacts'}));

      const toolbar = el('div',{class:'row',style:'justify-content:space-between;align-items:center;margin-bottom:8px'},[]);
      const left = el('div',{class:'search'},[ el('input',{class:'input',placeholder:'Search contacts...',id:'contactSearch'}) ]);
      const right = el('div',{class:'toolbar'},[
        el('select',{id:'contactFilter',class:'input',style:'width:auto'},[
          el('option',{value:'all',html:'All Types'}),
          el('option',{value:'Private Client',html:'Private Client'}),
          el('option',{value:'Commercial Client',html:'Commercial Client'}),
          el('option',{value:'Supplier',html:'Supplier'}),
          el('option',{value:'Other',html:'Other'}),
        ]),
        el('select',{id:'contactTagFilter',class:'input',style:'width:auto;margin-left:6px'},[ el('option',{value:'all',html:'All Tags'}) ]),
        el('button',{class:'chip',onclick:()=>openContactModal()},[document.createTextNode('+ Add Contact')])
      ]);
      toolbar.append(left,right);
      cardWrap.append(toolbar);

      const grid = el('div',{class:'contact-grid',id:'contactsGrid'});
      cardWrap.append(grid);
      wrap.append(cardWrap);
      $('#view').innerHTML=''; $('#view').append(wrap);

      function cardFor(c){
        const left = el('div',{},[
          el('div',{class:'contact-name',html:c.name||'(no name)'}),
          el('div',{class:'contact-meta',html:[
            c.type||'Other',
            c.company?` ‚Ä¢ ${c.company}`:'',
            (c.phone||c.email)?`<br>${c.phone||''}${c.email?(' ‚Ä¢ '+c.email):''}`:'',
          ].join('') + (c.tags && c.tags.length ? ('<div style="height:6px"></div>' + c.tags.map(t=>`<span class="chip" style="display:inline-block;margin-right:6px;background:var(--nav-hover)">${t}</span>`).join('')) : '')})
        ]);

        const actions = el('div',{class:'contact-actions'},[
          c.phone ? el('button',{class:'btn sm',onclick:(e)=>{e.stopPropagation();copyText(c.phone)}},[el('span',{html:renderIcon('copy')}),document.createTextNode('Copy Phone')]) : null,
          c.email ? el('button',{class:'btn sm',onclick:(e)=>{e.stopPropagation();copyText(c.email)}},[el('span',{html:renderIcon('copy')}),document.createTextNode('Copy Email')]) : null,
          el('button',{class:'btn sm',onclick:(e)=>{e.stopPropagation();openContactModal(c)}},[document.createTextNode('Edit')]),
          el('button',{class:'btn sm danger',onclick:(e)=>{e.stopPropagation(); if(confirm('Delete contact?')){ db.contacts = db.contacts.filter(x=>x.id!==c.id); persist(); refresh(); }}},[document.createTextNode('Delete')]),
        ].filter(Boolean));

        const card = el('div',{class:'contact-card',onclick:()=>viewContactModal(c)},[left, actions]);
        return card;
      }

      function refresh(){
        const q = $('#contactSearch').value?.toLowerCase() || '';
        const f = $('#contactFilter').value;
        grid.innerHTML='';

        let items = db.contacts.filter(c => (
          (c.name||'').toLowerCase().includes(q) ||
          (c.company||'').toLowerCase().includes(q) ||
          (c.email||'').toLowerCase().includes(q) ||
          (c.phone||'').toLowerCase().includes(q)
        ));
  if(f!=='all') items = items.filter(c=> (c.type||'Other')===f);
  const tf = $('#contactTagFilter') ? $('#contactTagFilter').value : 'all';
  if(tf && tf!=='all') items = items.filter(c=> (c.tags||[]).includes(tf));

        items.sort((a,b)=> (a.name||'').localeCompare(b.name||'', undefined, {sensitivity:'base'}));

        if(!items.length){
          grid.append(el('div',{class:'empty',html:'No contacts yet. Add your first contact to get started.'}));
          return;
        }
        items.forEach(c=> grid.append(cardFor(c)));
      }
      $('#contactSearch').addEventListener('input',refresh);
      $('#contactFilter').addEventListener('change',refresh);
      // populate contact tag filter
      (function populateContactTagFilter(){ const sel = $('#contactTagFilter'); if(!sel) return; const settings = loadSettings(); (settings.tags||[]).forEach(t=> sel.append(el('option',{value:t.name,html:t.name}))); sel.addEventListener('change',refresh); })();
      refresh();
    }

    function renderProjects(){
      const wrap = el('div',{});
      const inProgress = db.projects.filter(p=>p.status!=='Completed').length;
      const totalVal = db.projects.reduce((a,b)=>a+(+b.budget||0),0);
      wrap.append(el('div',{class:'stats'},[
        stat('b-blue','doc','Total Projects', db.projects.length),
        stat('b-green','wrench','In Progress', inProgress),
        stat('b-purple','folder','Completed', db.projects.filter(p=>p.status==='Completed').length),
        stat('b-yellow','credit','Total Value', currency(totalVal)),
      ]));
      wrap.append(el('div',{style:'height:12px'}));

      const cardWrap = el('div',{class:'card pad'});
      cardWrap.append(el('div',{class:'section-title',html:'Projects'}));

      const toolbar = el('div',{class:'row',style:'justify-content:space-between;align-items:center;margin-bottom:8px'},[]);
      const left = el('div',{class:'search'},[ el('input',{class:'input',placeholder:'Search projects...',id:'projectSearch'}) ]);
      const right = el('div',{class:'toolbar'},[ el('select',{id:'projectFilter',class:'input',style:'width:auto'},[
          el('option',{value:'all',html:'All Status'}),
          el('option',{value:'Planning',html:'Planning'}),
          el('option',{value:'In Progress',html:'In Progress'}),
          el('option',{value:'Completed',html:'Completed'}),
        ]),
        // tag filter
        el('select',{id:'projectTagFilter',class:'input',style:'width:auto;margin-left:6px'},[ el('option',{value:'all',html:'All Tags'}) ]),
        el('button',{class:'chip',onclick:()=>openProjectModal()},[document.createTextNode('+ Add Project')])
      ]);
      toolbar.append(left,right);
      cardWrap.append(toolbar);

      const table = el('table',{class:'table',id:'projectsTable'},[
        el('thead',{},[el('tr',{},[ 'Project Name','Client','Status','Budget','Dates','Actions'].map(h=>el('th',{html:h}))) ]),
        el('tbody',{})
      ]);
      cardWrap.append(table);
      wrap.append(cardWrap);
      $('#view').innerHTML=''; $('#view').append(wrap);

      function refresh(){
        const q = $('#projectSearch').value?.toLowerCase() || '';
  const f = $('#projectFilter').value;
  const tf = $('#projectTagFilter') ? $('#projectTagFilter').value : 'all';
        const body = $('#projectsTable tbody');
        body.innerHTML='';
        let items = db.projects.filter(p => ((p.name||'').toLowerCase().includes(q) || (p.client||'').toLowerCase().includes(q)));
  if(f!=='all') items = items.filter(p=> (p.status||'Planning')===f);
  if(tf && tf!=='all') items = items.filter(p=> (p.tags||[]).includes(tf));
        if(!items.length){ body.append(el('tr',{},[el('td',{colspan:6,class:'empty',html:'No projects yet. Add your first project to get started.'})])); return; }
        items.forEach(p=>{
          body.append(el('tr',{},[
            el('td',{html:p.name||''}),
            el('td',{html:p.client||''}),
            el('td',{html:p.status||'Planning'}),
            el('td',{html:currency(p.budget||0)}),
            el('td',{html:`${p.start||''} ‚Äì ${p.end||''}`}),
            el('td',{},[ el('div',{class:'row'},[
              el('button',{class:'btn',onclick:()=>openProjectModal(p)},[document.createTextNode('Edit')]),
               el('button',{class:'btn danger',onclick:()=>{ if(confirm('Delete project?')){ removeProjectCalendar(p.id); db.projects = db.projects.filter(x=>x.id!==p.id); persist(); refresh(); }}},[document.createTextNode('Delete')])
            ]) ])
          ]));
        });
      }
      $('#projectSearch').addEventListener('input',refresh);
      $('#projectFilter').addEventListener('change',refresh);
      // populate tag filter
      (function populateProjectTagFilter(){ const sel = $('#projectTagFilter'); if(!sel) return; const settings = loadSettings(); (settings.tags||[]).forEach(t=> sel.append(el('option',{value:t.name,html:t.name}))); sel.addEventListener('change',refresh); })();
      refresh();
    }

    function renderCalendar(){
      const view = $('#view');
      if(!view) return;
      view.innerHTML = '';

      const totalEvents = db.calendarEvents.length;
      const projectEvents = db.calendarEvents.filter(e=>e.source==='project').length;
      const personalEvents = totalEvents - projectEvents;
      const activeProjects = db.projects.filter(p=>p.status!=='Completed').length;

      const wrap = el('div',{class:'calendar-page'});
      wrap.append(el('div',{class:'stats'},[
        stat('b-blue','calendar','Scheduled Items', totalEvents),
        stat('b-green','wrench','Project Entries', projectEvents),
        stat('b-purple','star','Personal Notes', Math.max(personalEvents,0)),
        stat('b-yellow','clock','Active Projects', activeProjects)
      ]));
      wrap.append(el('div',{style:'height:12px'}));

      const layout = el('div',{class:'calendar-layout'});

      const calendarCard = el('div',{class:'card pad calendar-card'});
      const header = el('div',{class:'calendar-header'},[
        el('h2',{html:MONTH_FORMAT.format(calendarState.viewDate)}),
        el('div',{class:'calendar-nav'},[
          el('button',{class:'btn',onclick:()=>{ shiftMonth(-1); }},[document.createTextNode('‚óÄ')]),
          el('button',{class:'btn',onclick:()=>{ calendarState.viewDate = new Date(); renderCalendar(); }},[document.createTextNode('Today')]),
          el('button',{class:'btn',onclick:()=>{ shiftMonth(1); }},[document.createTextNode('‚ñ∂')]),
          el('button',{class:'chip',onclick:()=>openEventModal()},[document.createTextNode('+ Add Event')])
        ])
      ]);
      calendarCard.append(header);

      const dayNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      const dayRow = el('div',{class:'calendar-grid'}, dayNames.map(d=>el('div',{class:'calendar-day',html:d})));
      calendarCard.append(dayRow);

      const grid = el('div',{class:'calendar-grid'});
      const base = new Date(calendarState.viewDate.getFullYear(), calendarState.viewDate.getMonth(), 1);
      const startOffset = (base.getDay()+6)%7; // Monday-first
      base.setDate(base.getDate()-startOffset);

      const today = new Date();
      for(let i=0;i<42;i++){
        const current = new Date(base.getFullYear(), base.getMonth(), base.getDate()+i);
        const isCurrentMonth = current.getMonth()===calendarState.viewDate.getMonth();
        const cell = el('div',{class:'calendar-cell'+(isSameDay(current,today)?' today':'')});
        const dateLabel = el('div',{class:'calendar-date'+(isCurrentMonth?'':' muted'),html:String(current.getDate())});
        cell.append(dateLabel);

        const todaysEvents = db.calendarEvents.filter(ev=>eventOccursOn(ev, current));
        if(todaysEvents.length){
          const list = el('div',{class:'calendar-events'});
          todaysEvents.slice(0,3).forEach(ev=>{
            const badge = el('div',{
              class:'calendar-event',
              'data-type': ev.source==='project' ? 'project' : 'manual',
              onclick:()=>handleEventClick(ev)
            },[document.createTextNode(ev.title || 'Untitled Event')]);
            list.append(badge);
          });
          if(todaysEvents.length>3){
            list.append(el('div',{class:'muted',style:'font-size:11px'},[document.createTextNode(`+${todaysEvents.length-3} more`)]));
          }
          cell.append(list);
        }
        grid.append(cell);
      }
      calendarCard.append(grid);

      const sidebar = el('div',{class:'card pad calendar-sidebar'});
      sidebar.append(el('div',{class:'section-title',html:'Upcoming Schedule'}));
      const upcoming = el('div',{class:'event-list'});
      const sorted = db.calendarEvents
        .map(ev=>({ ev, range: eventRange(ev) }))
        .filter(({range})=>!!range)
        .sort((a,b)=>a.range.start - b.range.start)
        .map(({ev})=>ev);
      if(!sorted.length){
        upcoming.append(el('div',{class:'empty',html:'No events scheduled yet. Add an event or create a project to populate the calendar.'}));
      } else {
        sorted.forEach(ev=>{
          const card = el('div',{class:'event-card'});
          card.append(el('h3',{html:ev.title || 'Untitled Event'}));
          const metaBits = [formatEventRange(ev)];
          if(ev.client) metaBits.push(ev.client);
          if(ev.source==='project') metaBits.push('Project');
          card.append(el('div',{class:'event-meta',html:metaBits.join(' ‚Ä¢ ')}));
          if(ev.notes){
            card.append(el('div',{class:'muted',html:ev.notes}));
          }
          const actions = el('div',{class:'event-actions'});
          if(ev.source==='project'){
            actions.append(el('button',{class:'btn sm',onclick:()=>{
              const project = db.projects.find(p=>p.id===ev.sourceId);
              if(project){ openProjectModal(project); }
              else{ alert('Project not found.'); }
            }},[document.createTextNode('View Project')]));
          } else {
            actions.append(el('button',{class:'btn sm',onclick:()=>openEventModal(ev)},[document.createTextNode('Edit')]));
            actions.append(el('button',{class:'btn sm danger',onclick:()=>{
              if(confirm('Delete this event?')){
                db.calendarEvents = db.calendarEvents.filter(x=>x.id!==ev.id);
                persist();
                renderCalendar();
              }
            }},[document.createTextNode('Delete')]));
          }
          if(actions.children.length){ card.append(actions); }
          upcoming.append(card);
        });
      }
      sidebar.append(upcoming);

      layout.append(calendarCard, sidebar);
      wrap.append(layout);
      view.append(wrap);

      function shiftMonth(delta){
        const cur = calendarState.viewDate;
        calendarState.viewDate = new Date(cur.getFullYear(), cur.getMonth()+delta, 1);
        renderCalendar();
      }

      function handleEventClick(ev){
        if(ev.source==='project'){
          const project = db.projects.find(p=>p.id===ev.sourceId);
          if(project){ openProjectModal(project); }
          else{ alert('Project not found.'); }
        } else {
          openEventModal(ev);
        }
      }
    }

    /************ Sidebar drag & reorder + Mobile toggle ************/
    const NAV_ORDER_KEY = 'ew_nav_order';
  // templates removed

    function loadNavOrder(){
      return Store.get(NAV_ORDER_KEY, null);
    }
    function saveNavOrder(order){ Store.set(NAV_ORDER_KEY, order); }

    function applyNavOrder(){
      const nav = document.getElementById('nav');
      const saved = loadNavOrder();
      if(!saved || !Array.isArray(saved)) return hydrateInlineIcons();
      // Only reorder top-level anchors; leave groups and other nodes intact
      const children = Array.from(nav.children);
      const topAnchors = children.filter(n => n.tagName && n.tagName.toLowerCase()==='a');
      if(!topAnchors.length) { hydrateInlineIcons(); return; }
      const routeIndex = r => { const i = saved.indexOf(r); return i === -1 ? Number.MAX_SAFE_INTEGER : i; };
      const sortedAnchors = [...topAnchors].sort((a,b)=> routeIndex(a.dataset.route) - routeIndex(b.dataset.route));
      const finalNodes = [];
      let ai = 0;
      for(const child of children){
        if(child.tagName && child.tagName.toLowerCase()==='a'){
          finalNodes.push(sortedAnchors[ai++]);
        } else {
          finalNodes.push(child);
        }
      }
      nav.innerHTML = '';
      finalNodes.forEach(n=> nav.appendChild(n));
      hydrateInlineIcons();
    }
    applyNavOrder();

    function enableNavDrag(){
      const nav = document.getElementById('nav');
      let dragging = null;
      nav.addEventListener('dragstart', e=>{ if(e.target.matches(':scope > a')){ dragging = e.target; e.dataTransfer.effectAllowed='move'; e.target.classList.add('dragging'); } });
      nav.addEventListener('dragend', e=>{ if(dragging){ dragging.classList.remove('dragging'); dragging=null; } });
      nav.addEventListener('dragover', e=>{ if(!dragging) return; e.preventDefault(); const over = e.target.closest(':scope > a'); if(!over || over===dragging) return; // highlight
        $$('#nav a').forEach(a=>a.classList.toggle('drop-target', a===over));
      });
      nav.addEventListener('dragleave', e=>{ $$('#nav a').forEach(a=>a.classList.remove('drop-target')); });
      nav.addEventListener('drop', e=>{ e.preventDefault(); const over = e.target.closest(':scope > a'); if(!over || !dragging || over===dragging) return; over.classList.remove('drop-target'); nav.insertBefore(dragging, over.nextSibling); // place after target
        persistNavOrderFromDOM(); hydrationAfterChange();
      });

      // make anchors draggable and accessible
      $$('#nav > a').forEach(a=>{ a.setAttribute('draggable','true'); a.setAttribute('tabindex','0'); a.addEventListener('keydown', navKeyboardHandler); });
    }

    function navKeyboardHandler(e){
      // allow Ctrl+ArrowUp / Ctrl+ArrowDown to move items for keyboard users
      if(!(e.ctrlKey || e.metaKey)) return;
      if(e.key==='ArrowUp' || e.key==='ArrowDown'){
        e.preventDefault(); const a = e.currentTarget; const nav = document.getElementById('nav');
        if(e.key==='ArrowUp' && a.previousElementSibling) nav.insertBefore(a, a.previousElementSibling);
        if(e.key==='ArrowDown' && a.nextElementSibling) nav.insertBefore(a.nextElementSibling, a);
        persistNavOrderFromDOM(); hydrationAfterChange(); a.focus();
      }
    }

    function persistNavOrderFromDOM(){
      const order = $$('#nav > a').map(a=>a.dataset.route);
      saveNavOrder(order);
    }

    function hydrationAfterChange(){
      // reattach events for links and icons
      $$('#nav a').forEach(a=> a.addEventListener('click', ()=>{ document.getElementById('sidebar').classList.remove('open'); }));
      hydrateInlineIcons(); persist();
    }

    // Initialize drag and keyboard handlers
    enableNavDrag();

    // Nav groups: toggle/persist open state
    const NAV_GROUPS_KEY = 'ew_nav_groups';
    function loadNavGroups(){ return Store.get(NAV_GROUPS_KEY, {}); }
    function saveNavGroups(s){ Store.set(NAV_GROUPS_KEY, s); }
    (function initNavGroups(){
      const state = loadNavGroups();
      document.querySelectorAll('.nav-group').forEach(group => {
        const key = group.dataset.group;
        if(state[key]) group.classList.add('open');
        const header = group.querySelector('.nav-group-header');
        if(header){
          header.setAttribute('aria-expanded', String(group.classList.contains('open')));
          header.addEventListener('click', ()=>{
            group.classList.toggle('open');
            header.setAttribute('aria-expanded', String(group.classList.contains('open')));
            const s = loadNavGroups(); s[key] = group.classList.contains('open'); saveNavGroups(s);
          });
        }
      });
    })();

    // Menu open/close for mobile (attach after DOM ready)
    document.addEventListener('DOMContentLoaded', function() {
      const menuBtn = document.getElementById('menuBtn');
      const sidebar = document.getElementById('sidebar');
      const closeMobileBtn = document.getElementById('closeMobileBtn');
      if(menuBtn){
        menuBtn.setAttribute('aria-controls','sidebar');
        menuBtn.setAttribute('aria-expanded','false');
      }
      if(menuBtn && sidebar){
        menuBtn.addEventListener('click', ()=>{
          const opened = sidebar.classList.toggle('open');
          menuBtn.setAttribute('aria-expanded', String(!!opened));
        });
      }
      if(closeMobileBtn && sidebar){ closeMobileBtn.addEventListener('click', ()=> { sidebar.classList.remove('open'); menuBtn && menuBtn.setAttribute('aria-expanded','false'); }); }

      // ensure clicking a nav link closes sidebar on mobile (guarded)
      $$('#nav a').forEach(a=> a.addEventListener('click', ()=>{ const sb = document.getElementById('sidebar'); if(sb && window.innerWidth <= 980) { sb.classList.remove('open'); menuBtn && menuBtn.setAttribute('aria-expanded','false'); } }));

      // when resizing to desktop widths, ensure mobile sidebar is closed
      window.addEventListener('resize', ()=>{
        const sb = document.getElementById('sidebar');
        if(window.innerWidth > 980 && sb && sb.classList.contains('open')){ sb.classList.remove('open'); document.getElementById('menuBtn')?.setAttribute('aria-expanded','false'); }
      });
      // click outside sidebar to close on mobile
      document.addEventListener('click', (e)=>{
        const sb = document.getElementById('sidebar'); const btn = document.getElementById('menuBtn');
        if(!sb) return; if(!sb.classList.contains('open')) return;
        const withinSidebar = sb.contains(e.target);
        const withinButton = btn && btn.contains(e.target);
        if(!withinSidebar && !withinButton && window.innerWidth <= 980){ sb.classList.remove('open'); btn && btn.setAttribute('aria-expanded','false'); }
      });
    });

    // email templates removed

    // finalize initial hydration
    hydrateInlineIcons();


    /* SUPPLIERS ‚Äî UPDATED */
    function renderSuppliers(){
      const wrap = el('div',{});
      wrap.append(el('div',{class:'card pad'},[
        el('div',{class:'section-title',html:'Suppliers'}),
        el('div',{class:'toolbar',style:'margin-bottom:10px'},[
          el('button',{class:'chip',onclick:()=>openSupplierModal()},[document.createTextNode('+ Add Supplier')])
        ]),
        el('div',{class:'supplier-list',id:'supplierList'})
      ]));
      $('#view').innerHTML=''; $('#view').append(wrap);
      refreshSuppliers();
    }
    function supplierTile(s){
      const logo = el('div',{class:'supplier-logo'},[]);
      if(s.logo){ logo.append(el('img',{src:s.logo, alt:(s.name||'')})); }
      else{ logo.innerHTML = renderIcon('image'); }
      const meta = el('div',{class:'supplier-meta'},[
        el('div',{class:'supplier-name',html:s.name||'Unnamed Supplier'}),
        el('div',{class:'supplier-url',html:s.url||''})
      ]);
      const edit = el('button',{class:'btn',onclick:(e)=>{e.stopPropagation();openSupplierModal(s);}},[document.createTextNode('Edit')]);
      const del  = el('button',{class:'btn danger',onclick:(e)=>{e.stopPropagation(); if(confirm('Delete supplier?')){ db.suppliers = db.suppliers.filter(x=>x.id!==s.id); persist(); refreshSuppliers(); }}},[document.createTextNode('Delete')]);

      const tile = el('div',{class:'supplier-tile', onclick:()=>{ if(s.url){ const href = s.url.startsWith('http')? s.url : 'https://' + s.url; window.open(href,'_blank'); } }},[
        logo, meta, el('div',{class:'supplier-actions'},[edit, del])
      ]);
      return tile;
    }
    function refreshSuppliers(){
      const list = $('#supplierList'); list.innerHTML='';
      if(!db.suppliers.length){
        list.append(el('div',{class:'empty',html:'No suppliers yet. Add one to get started.'}));
        return;
      }
      db.suppliers.forEach(s=> list.append(supplierTile(s)));
    }

    function formField(label, control, hint=''){
      const w = el('div',{},[ el('div',{style:'font-weight:700;margin:6px 2px'},[document.createTextNode(label)]), control ]);
      if(hint) w.append(el('div',{class:'hint',html:hint}));
      return w;
    }

    function syncProjectCalendar(project){
      if(!project) return;
      const baseDate = project.start || project.end;
      if(!baseDate){
        removeProjectCalendar(project.id);
        return;
      }
      const payload = {
        title: project.name || 'Project',
        date: project.start || project.end,
        endDate: project.end || project.start || project.start,
        client: project.client || '',
        notes: project.notes || '',
        source: 'project',
        sourceId: project.id
      };
      const existing = db.calendarEvents.find(ev=>ev.source==='project' && ev.sourceId===project.id);
      if(existing){
        Object.assign(existing, payload);
      } else {
        db.calendarEvents.push({ id: crypto.randomUUID(), ...payload });
      }
    }

    function removeProjectCalendar(projectId){
      db.calendarEvents = db.calendarEvents.filter(ev=>!(ev.source==='project' && ev.sourceId===projectId));
    }

    (function initialProjectCalendarSync(){
      const before = JSON.stringify(db.calendarEvents);
      db.projects.forEach(p=>syncProjectCalendar(p));
      if(before !== JSON.stringify(db.calendarEvents)){
        persist();
      }
    })();

    // Broad delegated listener: if a click occurs on any topbar button that looks like the Privacy control, open overlay.
    document.addEventListener('click', (e)=>{
      try{
        const el = e.target && e.target.closest && e.target.closest('.top-actions .icon-btn, .top-actions button');
        if(!el) return;
        const txt = (el.textContent||'').trim().toLowerCase();
        const hasShield = !!el.querySelector('.ico[data-ico="shield"]') || !!el.querySelector('svg path[d*="M12 2l8 4v6"]');
        if(txt.includes('privacy') || hasShield){ openAwayOverlay(); e.preventDefault(); }
      }catch(err){ /* silent */ }
    }, {capture:false});

    /************ Modals ************/
    function openModal(title, bodyNode, onSubmit, submitText='Save', opts={}){
      const bd = $('#modalBackdrop'); bd.innerHTML='';
      const modal = el('div',{class:'modal'+(opts.className?(' '+opts.className):''), role:'dialog','aria-modal':'true'},[]);
      function closeModal(){ bd.style.display='none'; }
      modal.append(
        el('header',{},[
          el('h3',{html:title}),
          el('div',{class:'close-x',onclick:closeModal, title:'Close'},[document.createTextNode('‚úï')])
        ]),
        el('div',{class:'body'},[bodyNode]),
        el('div',{class:'footer'},[
          el('button',{class:'btn',onclick:closeModal},[document.createTextNode('Cancel')]),
          el('button',{class:'btn primary',onclick:()=>{ if(onSubmit()) closeModal(); }},[document.createTextNode(submitText)])
        ])
      );
      bd.append(modal); bd.style.display='flex';
      return { close: closeModal };
    }

    /* Icon picker (used by Links) */
    function iconPicker(selectedKey='link'){
      const wrap = el('div',{});
      wrap.append(el('div',{class:'muted', html:'Choose an icon'}));
      const grid = el('div',{class:'icon-grid'});
      ICON_KEYS.forEach(k=>{
        const opt = el('button',{type:'button', class:'icon-option'+(k===selectedKey?' selected':''), onclick:()=>{
          $$('.icon-option', grid).forEach(x=>x.classList.remove('selected'));
          opt.classList.add('selected');
          grid.dataset.selected = k;
        }},[]);
        opt.innerHTML = renderIcon(k);
        grid.append(opt);
      });
      grid.dataset.selected = selectedKey;
      wrap.append(grid);
      return { node: wrap, get: ()=>grid.dataset.selected };
    }

    /************ Add/Edit Modals (Links, Contacts, Projects) ************/
    function openLinkModal(link){
      const title = link ? 'Edit Quick Link' : 'Add Quick Link';
      const titleIn = el('input',{class:'input',placeholder:'Title',value:link?.title||''});
      const urlIn = el('input',{class:'input',placeholder:'https://example.com',value:link?.url||''});
      const colorSel = el('select',{class:'input'},[
        el('option',{value:'neutral',html:'Neutral'}),
        el('option',{value:'blue',html:'Blue'}),
        el('option',{value:'red',html:'Red'}),
        el('option',{value:'green',html:'Green'}),
        el('option',{value:'yellow',html:'Yellow'}),
        el('option',{value:'purple',html:'Purple'}),
      ]); colorSel.value = link?.color||'neutral';

      const picker = iconPicker(link?.icon||'link');

      const layout = el('div',{},[
        formField('Title', titleIn),
        formField('URL', urlIn),
        formField('Card Accent Colour', colorSel),
        formField('Icon', picker.node)
      ]);

      openModal(title, layout, ()=>{
        const payload = { title:titleIn.value.trim(), url:urlIn.value.trim(), icon:picker.get(), color:colorSel.value };
        if(!payload.title || !payload.url){ alert('Please provide a title and URL.'); return false; }
        if(link){ Object.assign(link, payload); } else { db.links.push({ id: crypto.randomUUID(), ...payload }); }
        persist(); route(); return true;
      }, link?'Save':'Add Link');
    }

    function openContactModal(contact){
      const title = contact ? 'Edit Contact' : 'Add New Contact';
      const nameIn = el('input',{class:'input',placeholder:'Enter contact name', value: contact?.name||''});
      const companyIn = el('input',{class:'input',placeholder:'Enter company name', value: contact?.company||''});
      const typeSel = el('select',{class:'input'},[
        el('option',{value:'Private Client',html:'Private Client'}),
        el('option',{value:'Commercial Client',html:'Commercial Client'}),
        el('option',{value:'Supplier',html:'Supplier'}),
        el('option',{value:'Other',html:'Other'}),
      ]); typeSel.value = contact?.type || 'Private Client';
      const phoneIn = el('input',{class:'input',placeholder:'Enter phone number', value: contact?.phone||''});
      const emailIn = el('input',{class:'input',placeholder:'Enter email address', value: contact?.email||''});

      const body = el('div',{},[
        formField('Name *', nameIn),
        formField('Company', companyIn),
        formField('Type', typeSel),
        formField('Tags', el('div',{id:'contactTagWrap',style:'display:flex;gap:8px;flex-wrap:wrap'},[])),
        formField('Phone', phoneIn),
        formField('Email', emailIn),
      ]);
      openModal(title, body, ()=>{
        if(!nameIn.value.trim()){ alert('Name is required.'); return false; }
        const payload = {
          name: nameIn.value.trim(),
          company: companyIn.value.trim(),
          type: typeSel.value,
          tags: Array.from(document.querySelectorAll('#contactTagWrap .tag-toggle.selected')).map(n=>n.dataset.tag),
          phone: phoneIn.value.trim(),
          email: emailIn.value.trim()
        };
        if(contact){ Object.assign(contact, payload); } else { db.contacts.push({ id: crypto.randomUUID(), ...payload }); }
        persist(); renderContacts(); return true;
      }, contact?'Save':'Add Contact');

      // render available tags as toggles
      (function renderContactTagOptions(){
        const wrap = document.getElementById('contactTagWrap'); if(!wrap) return;
        wrap.innerHTML='';
        const settings = loadSettings();
        (settings.tags||[]).forEach(t=>{
          const btn = el('button',{class:'chip tag-toggle',dataset:{tag:t.name},onclick:(e)=>{ e.preventDefault(); e.currentTarget.classList.toggle('selected'); }},[document.createTextNode(t.name)]);
          if(contact && (contact.tags||[]).includes(t.name)) btn.classList.add('selected');
          wrap.append(btn);
        });
      })();
    }

    /* Full details modal for a contact (click a card) ‚Äî wide, two-column, scrollable */
    function viewContactModal(contact){
      contact.address = contact.address || '';
      contact.jobRefs = contact.jobRefs || '';
      contact.notes   = contact.notes   || '';

      const nameIn    = el('input',{class:'input',value:contact.name||'',placeholder:'Name'});
      const companyIn = el('input',{class:'input',value:contact.company||'',placeholder:'Company'});
      const typeSel   = el('select',{class:'input'},[
        el('option',{value:'Private Client',html:'Private Client'}),
        el('option',{value:'Commercial Client',html:'Commercial Client'}),
        el('option',{value:'Supplier',html:'Supplier'}),
        el('option',{value:'Other',html:'Other'}),
      ]); typeSel.value = contact.type||'Private Client';
      const phoneIn   = el('input',{class:'input',value:contact.phone||'',placeholder:'Phone'});
      const emailIn   = el('input',{class:'input',value:contact.email||'',placeholder:'Email'});
      const addressIn = el('textarea',{class:'input',rows:'4',placeholder:'Address', html:contact.address});
      const refsIn    = el('textarea',{class:'input',rows:'3',placeholder:'Recent job ref(s) ‚Äî comma or line separated', html:contact.jobRefs});
      const notesIn   = el('textarea',{class:'input',rows:'5',placeholder:'Notes', html:contact.notes});

      const quick = el('div',{class:'row',style:'justify-content:flex-end'},[
        contact.phone ? el('button',{class:'btn sm',onclick:()=>copyText(contact.phone)},[el('span',{html:renderIcon('copy')}),document.createTextNode('Copy Phone')]) : null,
        contact.email ? el('button',{class:'btn sm',onclick:()=>copyText(contact.email)},[el('span',{html:renderIcon('copy')}),document.createTextNode('Copy Email')]) : null,
      ].filter(Boolean));

      const leftCol = el('div',{},[
        formField('Name', nameIn),
        formField('Company', companyIn),
        formField('Type', typeSel),
        formField('Tags', el('div',{id:'viewContactTags',style:'display:flex;gap:8px;flex-wrap:wrap'},[])),
        formField('Phone', phoneIn),
        formField('Email', emailIn),
      ]);
      const rightCol = el('div',{},[
        formField('Address', addressIn),
        formField('Recent Job Ref(s)', refsIn, 'E.g. WRAP-1023, WRAP-1049'),
        formField('Notes', notesIn)
      ]);

      const body = el('div',{},[
        quick,
        el('div',{class:'grid-2'},[leftCol, rightCol])
      ]);

      // render existing tags in details view
      (function renderViewContactTags(){
        const wrap = document.getElementById('viewContactTags'); if(!wrap) return; wrap.innerHTML='';
        const settings = loadSettings(); (settings.tags||[]).forEach(t=>{
          const chip = el('div',{class:'chip',dataset:{tag:t.name},style:`background:${t.color}22;border-color:${t.color}`},[document.createTextNode(t.name)]);
          if((contact.tags||[]).includes(t.name)) chip.classList.add('selected');
          chip.addEventListener('click',(e)=>{ e.currentTarget.classList.toggle('selected'); });
          wrap.append(chip);
        });
      })();

      openModal('Contact Details', body, ()=>{
        Object.assign(contact, {
          name: nameIn.value.trim(),
          company: companyIn.value.trim(),
          type: typeSel.value,
          phone: phoneIn.value.trim(),
          email: emailIn.value.trim(),
          address: addressIn.value.trim(),
          jobRefs: refsIn.value.trim(),
          notes: notesIn.value.trim(),
          tags: Array.from(document.querySelectorAll('#viewContactTags .chip.selected')).map(n=>n.dataset.tag)
        });
        persist();
        renderContacts();
        return true;
      }, 'Save Changes', { className:'wide' });
    }

    function openProjectModal(project){
      const title = project ? 'Edit Project' : 'Add New Project';
      const nameIn = el('input',{class:'input',placeholder:'Enter project name', value: project?.name||''});
      const clientIn = el('input',{class:'input',placeholder:'Client', value: project?.client||''});
      const statusSel = el('select',{class:'input'},[
        el('option',{value:'Planning',html:'Planning'}),
        el('option',{value:'In Progress',html:'In Progress'}),
        el('option',{value:'Completed',html:'Completed'}),
      ]); statusSel.value = project?.status||'Planning';
      const startIn = el('input',{class:'input',type:'date', value: project?.start||''});
      const endIn = el('input',{class:'input',type:'date', value: project?.end||''});
      const budgetIn = el('input',{class:'input',type:'number',placeholder:'0', value: project?.budget||0});

      // Extra fields: Vinyl + Notes
      const vinylIn  = el('input',{class:'input',placeholder:'e.g., 3M 2080 Satin Black', value: project?.vinyl||''});
      const notesIn  = el('textarea',{class:'input',placeholder:'Any extra info‚Ä¶', rows:'4', html: project?.notes||''});

      const body = el('div',{},[
        formField('Project Name *', nameIn),
        formField('Client', clientIn),
        formField('Status', statusSel),
        el('div',{class:'row',style:'gap:12px'},[formField('Start Date', startIn), formField('End Date', endIn)]),
        formField('Budget (¬£)', budgetIn),
        formField('Tags', el('div',{id:'projectTagWrap',style:'display:flex;gap:8px;flex-wrap:wrap'},[])),
        formField('Vinyl', vinylIn, 'Material/series/finish'),
        formField('Notes', notesIn, 'Optional')
      ]);
      openModal(title, body, ()=>{
        if(!nameIn.value.trim()){ alert('Project Name is required.'); return false; }
        const payload = {
          name:nameIn.value.trim(),
          client:clientIn.value.trim(),
          status:statusSel.value,
          start:startIn.value,
          end:endIn.value,
          budget:+budgetIn.value||0,
          tags: Array.from(document.querySelectorAll('#projectTagWrap .tag-toggle.selected')).map(n=>n.dataset.tag),
          vinyl:vinylIn.value.trim(),
          notes:notesIn.value.trim()
        };
        if(project){
          Object.assign(project, payload);
          syncProjectCalendar(project);
        } else {
          const fresh = { id: crypto.randomUUID(), ...payload };
          db.projects.push(fresh);
          syncProjectCalendar(fresh);
        }
        persist(); renderProjects(); return true;
      }, project?'Save':'Add Project');

  // render project tag options
  (function renderProjectTagOptions(){ const wrap = document.getElementById('projectTagWrap'); if(!wrap) return; wrap.innerHTML=''; const settings = loadSettings(); (settings.tags||[]).forEach(t=>{ const btn = el('button',{class:'chip tag-toggle',dataset:{tag:t.name},onclick:(e)=>{ e.preventDefault(); e.currentTarget.classList.toggle('selected'); }},[document.createTextNode(t.name)]); if(project && (project.tags||[]).includes(t.name)) btn.classList.add('selected'); wrap.append(btn); }); })();
    }

    function openEventModal(event){
      if(event?.source==='project'){
        const project = db.projects.find(p=>p.id===event.sourceId);
        if(project){ openProjectModal(project); }
        else{ alert('Project not found.'); }
        return;
      }

      const title = event ? 'Edit Calendar Event' : 'Add Calendar Event';
      const nameIn = el('input',{class:'input',placeholder:'Event title',value:event?.title||''});
      const startIn = el('input',{class:'input',type:'date',value:event?.date||''});
      const endIn = el('input',{class:'input',type:'date',value:event?.endDate||''});
      const tagIn = el('input',{class:'input',placeholder:'Tag or related client',value:event?.client||''});
      const notesIn = el('textarea',{class:'input',rows:'4',placeholder:'Notes or agenda',html:event?.notes||''});

      const body = el('div',{},[
        formField('Title *', nameIn),
        el('div',{class:'row',style:'gap:12px'},[
          formField('Start Date *', startIn),
          formField('End Date', endIn)
        ]),
        formField('Tag / Context', tagIn, 'Optional label shown in the upcoming list'),
        formField('Notes', notesIn)
      ]);

      openModal(title, body, ()=>{
        if(!nameIn.value.trim()){ alert('Event title is required.'); return false; }
        if(!startIn.value){ alert('Start date is required.'); return false; }
        if(endIn.value && endIn.value < startIn.value){ alert('End date cannot be before start date.'); return false; }
        const payload = {
          title: nameIn.value.trim(),
          date: startIn.value,
          endDate: endIn.value || startIn.value,
          client: tagIn.value.trim(),
          notes: notesIn.value.trim(),
          source: 'manual'
        };
        if(event){
          Object.assign(event, payload);
        } else {
          db.calendarEvents.push({ id: crypto.randomUUID(), ...payload });
        }
        persist(); renderCalendar(); return true;
      }, event?'Save Event':'Add Event');
    }

    /************ Supplier modal (with logo upload) ************/
    function openSupplierModal(supplier){
      const title = supplier ? 'Edit Supplier' : 'Add Supplier';
      const nameIn = el('input',{class:'input',placeholder:'Supplier name', value: supplier?.name||''});
      const urlIn = el('input',{class:'input',placeholder:'https://supplier.example.com', value: supplier?.url||''});
      const logoPrev = el('div',{class:'supplier-logo'},[]);
      const img = el('img',{alt:'logo preview'});
      if(supplier?.logo){ img.src = supplier.logo; logoPrev.append(img); } else { logoPrev.innerHTML = renderIcon('image'); }
      const fileIn = el('input',{type:'file',accept:'.png,.jpg,.jpeg,.svg',style:'display:none'});
      const pickBtn = el('button',{class:'btn',onclick:()=>fileIn.click()},[document.createTextNode('Upload Logo')]);
      fileIn.addEventListener('change', ()=>{
        const f = fileIn.files?.[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = ()=>{ img.src = reader.result; logoPrev.innerHTML=''; logoPrev.append(img); };
        reader.readAsDataURL(f);
      });
      const layout = el('div',{},[
        formField('Name', nameIn),
        formField('URL', urlIn),
        formField('Tags', el('div',{id:'supplierTagWrap',style:'display:flex;gap:8px;flex-wrap:wrap'},[])),
        formField('Logo', el('div',{},[logoPrev, el('div',{style:'height:8px'}), pickBtn]), 'PNG/JPG/SVG')
      ]);
      openModal(title, layout, ()=>{
  const payload = { name: nameIn.value.trim(), url: urlIn.value.trim(), logo: img.src||'', tags: Array.from(document.querySelectorAll('#supplierTagWrap .tag-toggle.selected')).map(n=>n.dataset.tag) };
        if(!payload.name || !payload.url){ alert('Please provide a name and URL.'); return false; }
        if(supplier){ Object.assign(supplier, payload); } else { db.suppliers.push({ id: crypto.randomUUID(), ...payload }); }
        persist(); refreshSuppliers(); return true;
      }, supplier?'Save':'Add Supplier');

  // render supplier tag options
  (function renderSupplierTagOptions(){ const wrap = document.getElementById('supplierTagWrap'); if(!wrap) return; wrap.innerHTML=''; const settings = loadSettings(); (settings.tags||[]).forEach(t=>{ const btn = el('button',{class:'chip tag-toggle',dataset:{tag:t.name},onclick:(e)=>{ e.preventDefault(); e.currentTarget.classList.toggle('selected'); }},[document.createTextNode(t.name)]); if(supplier && (supplier.tags||[]).includes(t.name)) btn.classList.add('selected'); wrap.append(btn); }); })();
    }

    /************ Brand Logo Upload (shared) ************/
    const LOGO_KEY = 'ew_logo_dataurl';
    // header handler (may not exist if upload moved to settings)
    const headerLogoFile = $('#logoFile');
    const uploadBtn = $('#uploadLogoBtn');
    if(uploadBtn && headerLogoFile){
      uploadBtn.addEventListener('click', ()=> headerLogoFile.click());
      headerLogoFile.addEventListener('change', ()=>{
        const f = headerLogoFile.files?.[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          const dataUrl = reader.result;
          localStorage.setItem(LOGO_KEY, dataUrl);
          applyLogos();
          // show toast confirmation
          if(typeof showToast === 'function') showToast('Logo updated', {type:'success'});
        };
        reader.readAsDataURL(f);
      });
    }
    function applyLogos(){
      // prefer the Settings-stored logo (single source of truth), fallback to legacy LOGO_KEY
      const settingsLogo = (function(){ try{ return loadSettings().logoDataUrl; }catch(e){ return null; } })();
      const dataUrl = settingsLogo || localStorage.getItem(LOGO_KEY);
      const mark = $('#logoMark');
      const markImg = $('#logoMarkImg');
      const topImg = $('#topLogoImg');
      const awayImg = $('#awayLogoImg');
      if(dataUrl){
        if(mark && mark.querySelector('span') && mark.querySelector('span').style) mark.querySelector('span').style.display='none';
        if(topImg && topImg.previousElementSibling) topImg.previousElementSibling.style.display='none';
        if(awayImg && awayImg.previousElementSibling) awayImg.previousElementSibling.style.display='none';
        if(markImg){ markImg.src = dataUrl; markImg.style.display='block'; }
        if(topImg){ topImg.src = dataUrl; topImg.style.display='block'; }
        if(awayImg){ awayImg.src = dataUrl; awayImg.style.display='block'; }
      }else{
        if(mark && mark.querySelector('span') && mark.querySelector('span').style) mark.querySelector('span').style.display='grid';
        const topSpan = document.querySelector('.top-logo span'); if(topSpan) topSpan.style.display='grid';
        const awaySpan = document.querySelector('.away .mark span'); if(awaySpan) awaySpan.style.display='grid';
        if(markImg) markImg.style.display='none';
        if(topImg) topImg.style.display='none';
        if(awayImg) awayImg.style.display='none';
      }
    }
    applyLogos();

    /************ Away Mode 2.0 ************/
    const PIN = '990704';
    const away = document.getElementById('awayOverlay');
    const pinInput = document.getElementById('pinInput');
    const keypad = document.getElementById('keypad');

    (function makeKeypad(){
      const keys = ['1','2','3','4','5','6','7','8','9','CLR','0','‚Üê'];
      keys.forEach(k=>{
        const b = document.createElement('button');
        b.textContent = k;
        b.setAttribute('aria-label', k==='‚Üê' ? 'Backspace' : (k==='CLR' ? 'Clear' : 'Number '+k));
        b.style.touchAction = 'manipulation';
        b.addEventListener('click', ()=>{
          if(k==='CLR'){ pinInput.value=''; return; }
          if(k==='‚Üê'){ pinInput.value = pinInput.value.slice(0,-1); return; }
          if(pinInput.value.length<6){ pinInput.value += k; tryUnlock(); }
        });
        keypad.appendChild(b);
      });
    })();

    // robust away button handler: attach directly or use delegated fallback
    function openAwayOverlay(){
      const awayEl = document.getElementById('awayOverlay');
      if(!awayEl) return;
      awayEl.style.display='flex';
      awayEl.setAttribute('aria-hidden','false');
      // mark controlling buttons as expanded
      const primary = document.getElementById('awayBtn'); if(primary) primary.setAttribute('aria-expanded','true');
      const fb = document.getElementById('awayBtnFallback'); if(fb) fb.setAttribute('aria-expanded','true');
      try{ const pInput = document.getElementById('pinInput'); if(pInput){ pInput.value=''; pInput.focus(); } }catch(e){}
      if(typeof showToast === 'function') showToast('Privacy enabled', {type:'success'});
    }
    // expose for inline onclick
    window.openAwayOverlay = openAwayOverlay;
    const awayBtnEl = document.getElementById('awayBtn');
    if(awayBtnEl){
      awayBtnEl.addEventListener('click', openAwayOverlay);
      // diagnostic check: log visibility and hit-test
      try{
        // silent visibility check (no console output)
        const cs = getComputedStyle(awayBtnEl);
        void (cs && awayBtnEl.offsetWidth && awayBtnEl.offsetHeight);
      }catch(e){ /* silent */ }
    } else {
      // fallback: delegate from document in case the button is dynamically replaced
      document.addEventListener('click', (e)=>{ if(e.target && e.target.closest && e.target.closest('#awayBtn')) openAwayOverlay(); });
    }

    // Close on Escape and add keyboard shortcut Ctrl/Cmd+L to open
    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='l'){ openAwayOverlay(); e.preventDefault(); }
      if(e.key==='Escape' && away && away.style.display==='flex'){
        away.style.display='none'; away.setAttribute('aria-hidden','true');
        const primary = document.getElementById('awayBtn'); if(primary) primary.setAttribute('aria-expanded','false');
        const fb = document.getElementById('awayBtnFallback'); if(fb) fb.setAttribute('aria-expanded','false');
      }
    });

    // clicking backdrop/outside the panel closes overlay
  if(away){ away.addEventListener('click', (e)=>{ if(e.target === away) { away.style.display='none'; away.setAttribute('aria-hidden','true'); const primary = document.getElementById('awayBtn'); if(primary) primary.setAttribute('aria-expanded','false'); const fb = document.getElementById('awayBtnFallback'); if(fb) fb.setAttribute('aria-expanded','false'); } }); }

    // Ensure there's always a clickable away button on desktop: create a fallback if original is missing/hidden
    (function ensureAwayBtnFallback(){
      try{
        const topActions = document.querySelector('.top-actions'); if(!topActions) return;
        const primary = document.getElementById('awayBtn');
        let need = false;
        if(!primary) need = true;
        else{
          const cs = getComputedStyle(primary);
          if(cs.display==='none' || cs.visibility==='hidden' || primary.offsetWidth===0 || primary.offsetHeight===0) need = true;
        }
        if(need && !document.getElementById('awayBtnFallback')){
          const fb = document.createElement('button');
          fb.className = 'icon-btn'; fb.id = 'awayBtnFallback'; fb.title='Away Mode';
          fb.innerHTML = '<span class="ico" data-ico="shield"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2l8 4v6c0 5-4 8-8 10-4-2-8-5-8-10V6z"></path></svg></span><span>Privacy</span>';
          // insert at start of top-actions so it's easy to find
          topActions.insertBefore(fb, topActions.firstChild);
          fb.addEventListener('click', openAwayOverlay);
        }
      }catch(e){ console.warn('ensureAwayBtnFallback failed', e); }
    })();

    function tryUnlock(){
      if(pinInput.value.length===6){
        if(pinInput.value===PIN){
          // show confirmation animation then close
          document.getElementById('awayOverlay').classList.add('show-confirm');
          // create confirm node if not present
          if(!document.querySelector('#awayOverlay .confirm')){
            const c = document.createElement('div'); c.className='confirm'; c.innerHTML = `<div class="check">‚úì</div>`;
            document.getElementById('awayOverlay').appendChild(c);
          }
          setTimeout(()=>{
            const overlay = document.getElementById('awayOverlay');
            overlay.classList.remove('show-confirm');
            overlay.style.display='none';
            pinInput.value='';
          }, 700);
        } else {
          const p = pinInput;
          p.classList.remove('shake'); void p.offsetWidth; p.classList.add('shake');
          p.value='';
        }
      }
    }
    pinInput.addEventListener('input', tryUnlock);

    // Particle shimmer
    (function particles(){
      const c = document.getElementById('particles');
      const ctx = c.getContext('2d');
      function resize(){ c.width = innerWidth; c.height = innerHeight; }
      window.addEventListener('resize', resize); resize();
      const dots = Array.from({length: 70}, ()=>({
        x: Math.random()*c.width,
        y: Math.random()*c.height,
        r: Math.random()*2+0.5,
        a: Math.random()*Math.PI*2,
        s: Math.random()*0.6+0.2
      }));
      function step(){
        ctx.clearRect(0,0,c.width,c.height);
        for(const d of dots){
          d.x += Math.cos(d.a)*d.s; d.y += Math.sin(d.a)*d.s;
          if(d.x<0||d.x>c.width||d.y<0||d.y>c.height){ d.x=Math.random()*c.width; d.y=Math.random()*c.height; }
          const grad = ctx.createRadialGradient(d.x,d.y,0,d.x,d.y,d.r*6);
          grad.addColorStop(0,'rgba(1,250,191,.35)');
          grad.addColorStop(1,'rgba(0,181,255,.00)');
          ctx.fillStyle = grad;
          ctx.beginPath(); ctx.arc(d.x,d.y,d.r*6,0,Math.PI*2); ctx.fill();
        }
        requestAnimationFrame(step);
      }
      step();
    })();

    /************ Nav/Menu + Init ************/
  // (moved above, attached after DOMContentLoaded)
    // toast helper
    function showToast(message, opts={}){
      try{
        const wrap = document.getElementById('toastWrap'); if(!wrap) return;
        const t = document.createElement('div'); t.className='toast';
        if(opts.type==='success') t.classList.add('success');
        if(opts.type==='warn' || opts.type==='warning') t.classList.add('warn');
        t.textContent = message;
        const close = document.createElement('span'); close.className='close'; close.textContent='‚úï'; close.setAttribute('role','button'); close.tabIndex=0;
        close.addEventListener('click', ()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),200); });
        t.appendChild(close);
        wrap.appendChild(t);
        // show
        requestAnimationFrame(()=> t.classList.add('show'));
        const ttl = typeof opts.ttl === 'number' ? opts.ttl : 3500;
        const to = setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),200); }, ttl);
        // keyboard dismiss
        close.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); clearTimeout(to); t.classList.remove('show'); setTimeout(()=>t.remove(),200); } });
      }catch(e){ console.warn('toast error', e); }
    }

    route();           // render initial view
    hydrateInlineIcons(); // ensure topbar/sidebar icons render on first load

    /************ Accessibility niceties ************/
    pinInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ tryUnlock(); }});
  </script>

  <!-- Firebase client initialization & helpers (optional, used if present) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js';
  import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, serverTimestamp, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js';
  import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCnYFHzbR7iWbHvEj3hBq7mOBe7p7VBMSY",
      authDomain: "elite-hq-6e0b7.firebaseapp.com",
      projectId: "elite-hq-6e0b7",
      // storageBucket normalized to the common appspot.com form (if your project uses a different bucket value, replace it with your exact value)
      storageBucket: "elite-hq-6e0b7.appspot.com",
      messagingSenderId: "454926724633",
      appId: "1:454926724633:web:2a8c649dde977b7c94c488"
    };

    try{
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      // Initialize Auth and sign in anonymously so client can perform allowed writes under secure rules
      try{
        const auth = getAuth(app);
        // expose current user to the app
        window.FirebaseAuth = auth;
        onAuthStateChanged(auth, (user) => {
          window.FirebaseUser = user || null;
          if(user) console.info('Firebase anonymous auth ready', user.uid);
          else console.info('Firebase auth state: signed out');
        });
        // attempt anonymous sign-in if no user present
        (async ()=>{
          try{
            if(!auth.currentUser){
              await signInAnonymously(auth);
              console.info('Anonymous sign-in succeeded');
            }
          }catch(e){ console.warn('Anonymous sign-in failed', e); }
        })();
      }catch(e){ console.warn('Auth init failed', e); }

      function makeCode(len=6){ return Math.random().toString(36).substring(2,2+len).toUpperCase(); }

      async function createReferral({ clientName, jobRef, jobTotal }){
        const referralCode = makeCode(6);
        const rec = { referralCode, clientName: clientName||'', jobRef: jobRef||'', jobTotal: Number(jobTotal)||0, used:false, createdAt: serverTimestamp() };
        const r = await addDoc(collection(db,'referrals'), rec);
        return { id: r.id, ...rec };
      }

      async function listReferrals(){
        const snap = await getDocs(collection(db,'referrals'));
        return snap.docs.map(d=>({ id:d.id, ...d.data() }));
      }

      async function getReferralByCode(code){
        const q = query(collection(db,'referrals'), where('referralCode','==', code));
        const snap = await getDocs(q);
        if(snap.empty) return null;
        return { id: snap.docs[0].id, ...snap.docs[0].data() };
      }

      async function useReferralCode(code, newClientName){
        const q = query(collection(db,'referrals'), where('referralCode','==', code));
        const snap = await getDocs(q);
        if(snap.empty) throw new Error('Code not found');
        const d = snap.docs[0]; const data = d.data();
        if(data.used) throw new Error('Code already used');
        await updateDoc(d.ref, { used:true, usedBy: newClientName, usedDate: serverTimestamp() });
        return { id: d.id, ...data, used:true, usedBy: newClientName };
      }

      async function saveSignature(payload){ // payload: { name, email, address, ref, reason, signatureDataUrl, ip }
        const rec = { ...payload, createdAt: serverTimestamp() };
        const r = await addDoc(collection(db,'signatures'), rec);
        return { id: r.id, ...rec };
      }

      // Save/load general Elite-HQ data. We store each top-level page as its own
      // document under collection 'elitehq' (docs: links, contacts, projects,
      // suppliers, calendar, referrals). Each document shape is:
      // { data: <array|object>, updatedAt: <Firestore Timestamp> }
      // For compatibility we return an object like: { data: { links: {...}, ... }, updatedAt: <ISO string|null> }
      // Note: This is a simple client-side helper. For sensitive operations, use authenticated/secured endpoints and Firestore rules.
      async function saveHQData(payload){
        // If no payload provided, build it from local in-memory db and the referrals collection
        if(!payload || typeof payload !== 'object'){
          payload = {
            links: db.links || [],
            contacts: db.contacts || [],
            projects: db.projects || [],
            suppliers: db.suppliers || [],
            calendarEvents: db.calendarEvents || []
          };
          // gather referrals from the 'referrals' collection so we mirror that data into elitehq/referrals
          try{
            const snap = await getDocs(collection(db,'referrals'));
            payload.referrals = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          }catch(e){ console.warn('saveHQData: failed to read referrals collection', e); payload.referrals = null; }
        }

        const keys = Object.keys(payload);
        const ops = [];
        for(const k of keys){
          try{
            const ref = doc(db, 'elitehq', k);
            // write per-doc with server timestamp
            ops.push(setDoc(ref, { data: payload[k], updatedAt: serverTimestamp() }, { merge: true }));
          }catch(e){ console.warn('saveHQData write queued failed for',k,e); }
        }
        await Promise.all(ops);
        return true;
      }

      async function loadHQData(){
        // Read the standard set of docs and return a compatibility object
        const keys = ['links','contacts','projects','suppliers','calendarEvents','calendar','referrals'];
        const out = { data: {} };
        let latest = null;
        for(const k of keys){
          try{
            const ref = doc(db, 'elitehq', k);
            const snap = await getDoc(ref);
            if(!snap.exists()){ out.data[k] = null; continue; }
            const d = snap.data() || {};
            // convert updatedAt to ISO if it's a Firestore Timestamp
            let updatedAtIso = null;
            if(d.updatedAt){
              if(d.updatedAt.toDate && typeof d.updatedAt.toDate === 'function'){
                updatedAtIso = d.updatedAt.toDate().toISOString();
              } else if(typeof d.updatedAt === 'string'){
                updatedAtIso = d.updatedAt;
              }
            }
            out.data[k] = { data: d.data === undefined ? null : d.data, updatedAt: updatedAtIso };
            if(updatedAtIso){
              const t = Date.parse(updatedAtIso);
              if(!Number.isNaN(t) && (!latest || t > latest)) latest = t;
            }
          }catch(e){ console.warn('loadHQData read failed for',k,e); out.data[k] = null; }
        }
        out.updatedAt = latest ? new Date(latest).toISOString() : null;
        return out;
      }

      async function listTemplates(){ const snap = await getDocs(collection(db,'templates')); return snap.docs.map(d=>({ id:d.id, ...d.data() })); }

  window.FirebaseHelpers = { createReferral, listReferrals, getReferralByCode, useReferralCode, saveSignature, listTemplates, saveHQData, loadHQData };
      console.info('FirebaseHelpers initialized');
      // After Firebase is ready - try to merge remote docs into local and push a backup
      (async ()=>{
        try{
          const remote = await loadHQData();
          const keys = ['links','contacts','projects','suppliers','calendarEvents','referrals'];
          if(remote && remote.data){
            let merged = false;
            for(const k of keys){
              const docObj = remote.data[k];
              // docObj may be { data: [...] , updatedAt: iso } or null
              const arr = docObj && Array.isArray(docObj.data) ? docObj.data : null;
              // merge only when local is empty to avoid overwriting user's current data
              if(arr && (!db[k] || (Array.isArray(db[k]) && db[k].length===0))){
                // map calendar -> calendarEvents if necessary
                if(k === 'calendar' && Array.isArray(arr)) db.calendarEvents = arr;
                else if(k === 'calendarEvents') db.calendarEvents = arr;
                else if(k === 'referrals') {
                  // referrals are not part of local db model; ignore merging into db but keep for initial backup
                } else if(k in db){ db[k] = arr; }
                merged = true;
              }
            }
            if(merged){ persist(); console.info('Merged remote elitehq docs into local db'); }
          }

          // Ensure we push current local state to Firestore now so contacts/projects/etc are backed up
          if(window.FirebaseHelpers && typeof window.FirebaseHelpers.saveHQData === 'function'){
            try{
              await window.FirebaseHelpers.saveHQData({ links: db.links, contacts: db.contacts, projects: db.projects, suppliers: db.suppliers, calendarEvents: db.calendarEvents });
              console.info('Initial backup: elitehq docs saved');
            }catch(e){ console.warn('Initial backup failed', e); }
          }
        }catch(e){ console.warn('Merge/load backup failed', e); }
      })();

      // Expose a manual backup helper for debugging and user-triggered backups
      window.manualBackup = async function(){
        if(!window.FirebaseHelpers || typeof window.FirebaseHelpers.saveHQData !== 'function') throw new Error('FirebaseHelpers not ready');
        await window.FirebaseHelpers.saveHQData();
        console.info('Manual backup complete');
      };
    }catch(e){ console.warn('Firebase init failed', e); }
  </script>
</body>
</html>
